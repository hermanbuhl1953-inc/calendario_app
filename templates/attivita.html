{% extends "base.html" %}

{% block title %}Gestione Tipi Attività - Calendario Istruttori{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-tasks"></i> Gestione Tipi Attività</h2>
        <hr>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#modalAttivita" onclick="nuovaAttivita()">
            <i class="fas fa-plus"></i> Aggiungi Nuovo Tipo Attività
        </button>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-list"></i> Tipi Attività Disponibili</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Colore</th>
                                <th>Anteprima</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for att in attivita %}
                            <tr>
                                <td><strong>{{ att.nome }}</strong></td>
                                <td>
                                    <span class="badge bg-secondary">{{ att.categoria }}</span>
                                </td>
                                <td><code>#{{ att.colore }}</code></td>
                                <td>
                                    <span class="badge" style="background-color: #{{ att.colore }}; padding: 8px 15px;">
                                        {{ att.nome[:15] }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-warning" onclick="modificaAttivita({{ att.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="eliminaAttivita({{ att.id }}, '{{ att.nome }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-palette"></i> Palette Colori Suggeriti</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <p><strong>Corsi:</strong></p>
                        <p><span class="badge" style="background-color: #52BE80;">Verde #52BE80</span></p>
                        <p><span class="badge" style="background-color: #5DADE2;">Azzurro #5DADE2</span></p>
                        <p><span class="badge" style="background-color: #BB8FCE;">Viola #BB8FCE</span></p>
                        <p><span class="badge" style="background-color: #F39C12;">Arancione #F39C12</span></p>
                    </div>
                    <div class="col-6">
                        <p><strong>Esami:</strong></p>
                        <p><span class="badge" style="background-color: #3498DB;">Blu #3498DB</span></p>
                        <p><span class="badge" style="background-color: #2874A6;">Blu scuro #2874A6</span></p>
                        <p><span class="badge" style="background-color: #5499C7;">Blu chiaro #5499C7</span></p>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <p><strong>Assenze:</strong></p>
                        <p><span class="badge" style="background-color: #F1C40F; color: #000;">Giallo #F1C40F</span></p>
                        <p><span class="badge" style="background-color: #E74C3C;">Rosso #E74C3C</span></p>
                    </div>
                    <div class="col-6">
                        <p><strong>Altro:</strong></p>
                        <p><span class="badge" style="background-color: #95A5A6;">Grigio #95A5A6</span></p>
                        <p><span class="badge" style="background-color: #48C9B0;">Cyan #48C9B0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> Come Funziona</h5>
            <ul>
                <li><strong>Aggiungi:</strong> Click "Aggiungi Nuovo Tipo Attività" per creare una nuova attività</li>
                <li><strong>Modifica:</strong> Click su icona matita per modificare nome, colore o categoria</li>
                <li><strong>Elimina:</strong> Click cestino per eliminare (solo se non usata in impegni)</li>
                <li><strong>Colore:</strong> Usa codice esadecimale (es. #FF5733) o scegli dalla palette</li>
            </ul>
            
            <h6 class="mt-3"><strong>Categorie Disponibili:</strong></h6>
            <p>
                <span class="badge bg-success">CORSO</span>
                <span class="badge bg-primary">ESAME</span>
                <span class="badge bg-warning text-dark">ASSENZA</span>
                <span class="badge bg-info">TIROCINIO</span>
                <span class="badge bg-secondary">ALTRO</span>
            </p>
        </div>
    </div>
</div>

<!-- Modal Attività -->
<div class="modal fade" id="modalAttivita" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Nuova Attività</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formAttivita">
                    <input type="hidden" id="attivita_id">
                    
                    <div class="mb-3">
                        <label class="form-label">Nome Attività *</label>
                        <input type="text" class="form-control" id="nome" required 
                               placeholder="es. CORSO SPECIFICO">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Categoria *</label>
                        <select class="form-select" id="categoria" required>
                            <option value="CORSO">CORSO</option>
                            <option value="ESAME">ESAME</option>
                            <option value="TIROCINIO">TIROCINIO</option>
                            <option value="ADDESTRAMENTO">ADDESTRAMENTO</option>
                            <option value="PRATICHE">PRATICHE</option>
                            <option value="ASSENZA">ASSENZA</option>
                            <option value="ALTRO">ALTRO</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Colore (Esadecimale) *</label>
                        <div class="input-group">
                            <span class="input-group-text">#</span>
                            <input type="text" class="form-control" id="colore" required 
                                   placeholder="52BE80" maxlength="6" pattern="[0-9A-Fa-f]{6}">
                            <input type="color" class="form-control form-control-color" id="colorPicker" 
                                   title="Scegli colore">
                        </div>
                        <small class="text-muted">Formato: 6 caratteri esadecimali (es. 52BE80)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Anteprima:</label>
                        <div>
                            <span class="badge" id="anteprima" style="padding: 10px 20px; font-size: 1rem;">
                                ANTEPRIMA
                            </span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Annulla
                </button>
                <button type="button" class="btn btn-primary" onclick="salvaAttivita()">
                    <i class="fas fa-save"></i> Salva
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let modalAttivita = null;
let modalInstance = null;

$(document).ready(function() {
    modalAttivita = $('#modalAttivita');
    modalInstance = new bootstrap.Modal(modalAttivita[0]);
    
    // Sync color picker con input hex
    $('#colorPicker').on('input', function() {
        const hex = $(this).val().substring(1); // Rimuovi #
        $('#colore').val(hex.toUpperCase());
        aggiornaAnteprima();
    });
    
    $('#colore').on('input', function() {
        const hex = $(this).val();
        if (hex.length === 6) {
            $('#colorPicker').val('#' + hex);
        }
        aggiornaAnteprima();
    });
    
    $('#nome').on('input', aggiornaAnteprima);
});

function nuovaAttivita() {
    $('#modalTitle').text('Nuova Attività');
    $('#formAttivita')[0].reset();
    $('#attivita_id').val('');
    $('#colore').val('52BE80');
    $('#colorPicker').val('#52BE80');
    aggiornaAnteprima();
}

function modificaAttivita(id) {
    $.getJSON('/api/tipi-attivita', function(data) {
        const attivita = data.find(a => a.id === id);
        if (attivita) {
            $('#modalTitle').text('Modifica Attività');
            $('#attivita_id').val(attivita.id);
            $('#nome').val(attivita.nome);
            $('#categoria').val(attivita.categoria);
            $('#colore').val(attivita.colore);
            $('#colorPicker').val('#' + attivita.colore);
            
            aggiornaAnteprima();
            modalInstance.show();
        }
    });
}

function aggiornaAnteprima() {
    const nome = $('#nome').val() || 'ANTEPRIMA';
    const colore = $('#colore').val() || '52BE80';
    
    $('#anteprima')
        .text(nome)
        .css('background-color', '#' + colore);
}

function salvaAttivita() {
    const id = $('#attivita_id').val();
    const nome = $('#nome').val().trim();
    const colore = $('#colore').val().trim().toUpperCase();
    const categoria = $('#categoria').val();
    
    if (!nome) {
        alert('Inserire il nome!');
        return;
    }
    
    if (!/^[0-9A-F]{6}$/i.test(colore)) {
        alert('Colore non valido! Usa formato esadecimale (es. 52BE80)');
        return;
    }
    
    const data = {
        nome: nome,
        colore: colore,
        categoria: categoria
    };
    
    const url = id ? `/api/tipi-attivita/${id}` : '/api/tipi-attivita';
    const method = id ? 'PUT' : 'POST';
    
    $.ajax({
        url: url,
        method: method,
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function() {
            alert('Attività salvata con successo!');
            location.reload();
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Errore sconosciuto';
            alert('Errore: ' + error);
        }
    });
}

function eliminaAttivita(id, nome) {
    if (confirm(`Confermi di eliminare il tipo attività "${nome}"?\n\nATTENZIONE: Non puoi eliminare attività usate in impegni esistenti!`)) {
        $.ajax({
            url: `/api/tipi-attivita/${id}`,
            method: 'DELETE',
            success: function() {
                alert('Tipo attività eliminato!');
                location.reload();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Errore nell\'eliminare';
                alert('Errore: ' + error);
            }
        });
    }
}
</script>
{% endblock %}
<html xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882"><head>
<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:xd_Signature msdt:dt="string"></mso:xd_Signature>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor msdt:dt="string">Grifasi Angelo Giuseppe</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor>
<mso:Order msdt:dt="string">192200.000000000</mso:Order>
<mso:ComplianceAssetId msdt:dt="string"></mso:ComplianceAssetId>
<mso:TemplateUrl msdt:dt="string"></mso:TemplateUrl>
<mso:xd_ProgID msdt:dt="string"></mso:xd_ProgID>
<mso:_ExtendedDescription msdt:dt="string"></mso:_ExtendedDescription>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author msdt:dt="string">Grifasi Angelo Giuseppe</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author>
<mso:TriggerFlowInfo msdt:dt="string"></mso:TriggerFlowInfo>
<mso:ContentTypeId msdt:dt="string">0x0101002AC836DBC1B2D14B9CF1B153B23CAC72</mso:ContentTypeId>
<mso:_SourceUrl msdt:dt="string"></mso:_SourceUrl>
<mso:_SharedFileIndex msdt:dt="string"></mso:_SharedFileIndex>
<mso:TaxCatchAll msdt:dt="string"></mso:TaxCatchAll>
<mso:MediaServiceImageTags msdt:dt="string"></mso:MediaServiceImageTags>
<mso:lcf76f155ced4ddcb4097134ff3c332f msdt:dt="string"></mso:lcf76f155ced4ddcb4097134ff3c332f>
</mso:CustomDocumentProperties>
</xml><![endif]-->
<title></title></head>