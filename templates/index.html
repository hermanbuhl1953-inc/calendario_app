{% extends "base.html" %}

{% block title %}Dashboard - Calendario Istruttori{% endblock %}

{% block content %}
<!-- Header Giornaliero -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body text-white py-4">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h2 class="mb-1"><i class="fas fa-calendar-day"></i> <span id="data-oggi">Caricamento...</span></h2>
                        <p class="mb-0 opacity-75">Dashboard Operativa Giornaliera</p>
                    </div>
                    <div class="col-md-6">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="bg-white bg-opacity-25 rounded p-2">
                                    <h3 class="mb-0" id="stat-impegni-oggi">-</h3>
                                    <small>Impegni Oggi</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="bg-white bg-opacity-25 rounded p-2">
                                    <h3 class="mb-0" id="stat-corsi-oggi">-</h3>
                                    <small>Corsi Attivi</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="bg-white bg-opacity-25 rounded p-2">
                                    <h3 class="mb-0" id="stat-istruttori-oggi">-</h3>
                                    <small>Istruttori</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Impegni di Oggi -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-white border-bottom">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0"><i class="fas fa-list-check text-primary"></i> Impegni di Oggi</h5>
                    </div>
                    <div class="col-md-6">
                        <select class="form-select form-select-sm" id="filtroCategoria" onchange="filtraPerCategoria()">
                            <option value="">Tutte le categorie</option>
                            <option value="CORSO">Solo Corsi</option>
                            <option value="ESAME">Solo Esami</option>
                            <option value="ADDESTRAMENTO">Solo Addestramento</option>
                            <option value="ASSENZA">Solo Assenze</option>
                            <option value="ALTRO">Altro</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="impegni-oggi-lista" class="list-group list-group-flush">
                    <!-- Popolato via JS -->
                    <div class="list-group-item text-center text-muted py-5">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Caricamento impegni...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar Azioni -->
    <div class="col-lg-4">
        <!-- Conflitti -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Conflitti da Risolvere</h6>
            </div>
            <div class="card-body p-0">
                <div id="conflitti-lista" class="list-group list-group-flush">
                    <div class="list-group-item text-center text-muted">
                        Caricamento...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Azioni Rapide -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fas fa-bolt"></i> Azioni Rapide</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/impegni" class="btn btn-outline-primary">
                        <i class="fas fa-plus"></i> Nuovo Impegno
                    </a>
                    <a href="/calendario/2026" class="btn btn-outline-success">
                        <i class="fas fa-calendar"></i> Calendario 2026
                    </a>
                    <a href="/istruttori" class="btn btn-outline-info">
                        <i class="fas fa-users"></i> Gestione Istruttori
                    </a>
                    <a href="/export/excel" class="btn btn-outline-secondary">
                        <i class="fas fa-download"></i> Esporta Excel
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prossimi 7 Giorni -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0"><i class="fas fa-calendar-week text-success"></i> Prossimi 7 Giorni</h5>
            </div>
            <div class="card-body">
                <div class="row text-center" id="prossimi-giorni">
                    <!-- Popolato via JS -->
                    <div class="col text-muted">Caricamento...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let impegniOggi = []; // Salva tutti gli impegni per filtro

function normalizeColor(hex) {
    if (!hex) return '#6c757d';
    if (hex.startsWith('#')) return hex;
    return `#${hex}`;
}

function getContrastColor(hex) {
    const color = hex.replace('#', '');
    if (color.length !== 6) return '#ffffff';
    const r = parseInt(color.substr(0, 2), 16);
    const g = parseInt(color.substr(2, 2), 16);
    const b = parseInt(color.substr(4, 2), 16);
    const yiq = (r * 299 + g * 587 + b * 114) / 1000;
    return yiq >= 160 ? '#0f1720' : '#ffffff';
}

function filtraPerCategoria() {
    const categoria = $('#filtroCategoria').val();
    renderImpegni(categoria);
}

function renderImpegni(filtraCategoria = '') {
    const listaImpegni = $('#impegni-oggi-lista');
    listaImpegni.empty();
    
    let impegniFiltrati = impegniOggi;
    if (filtraCategoria) {
        impegniFiltrati = impegniOggi.filter(imp => imp.categoria === filtraCategoria);
    }
    
    if (impegniFiltrati.length === 0) {
        listaImpegni.append(`
            <div class="list-group-item text-center text-muted py-5">
                <i class="fas fa-filter fa-2x mb-3"></i>
                <h5>Nessun impegno trovato${filtraCategoria ? ' per questa categoria' : ''}!</h5>
            </div>
        `);
        return;
    }
    
    impegniFiltrati.forEach(function(imp) {
        const bg = normalizeColor(imp.colore);
        const textColor = getContrastColor(bg);
        const card = `
            <div class="list-group-item list-group-item-action" data-categoria="${imp.categoria}">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <span class="badge rounded-pill me-2" style="background-color: ${bg}; color: ${textColor}; min-width: 120px;">
                                ${imp.attivita_nome}
                            </span>
                            <strong>${imp.istruttore_nome}</strong>
                        </div>
                        <div class="text-muted small">
                            ${imp.id_corso ? `<i class="fas fa-graduation-cap"></i> ${imp.id_corso}` : ''}
                            <span class="ms-2"><i class="fas fa-calendar"></i> ${imp.data_inizio} → ${imp.data_fine}</span>
                            ${imp.giorni_lavorativi ? `<span class="ms-2"><i class="fas fa-clock"></i> ${imp.giorni_lavorativi} giorni</span>` : ''}
                        </div>
                        ${imp.note ? `<div class="small mt-1"><i class="fas fa-sticky-note"></i> ${imp.note}</div>` : ''}
                    </div>
                    <div>
                        ${imp.id_corso ? `<a href="/corso/${encodeURIComponent(imp.id_corso)}" class="btn btn-sm btn-outline-primary"><i class="fas fa-arrow-right"></i></a>` : ''}
                    </div>
                </div>
            </div>
        `;
        listaImpegni.append(card);
    });
}

$(document).ready(function() {
    // Carica dashboard
    $.getJSON('/api/dashboard', function(data) {
        // Header data
        const dataOggi = new Date(data.oggi);
        const giorni = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];
        const mesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                      'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        const testoData = `${giorni[dataOggi.getDay()]}, ${dataOggi.getDate()} ${mesi[dataOggi.getMonth()]} ${dataOggi.getFullYear()}`;
        $('#data-oggi').text(testoData);
        
        // Statistiche oggi
        $('#stat-impegni-oggi').text(data.stats.totale_impegni);
        $('#stat-corsi-oggi').text(data.stats.corsi_attivi);
        $('#stat-istruttori-oggi').text(data.stats.istruttori_occupati);
        
        // Salva impegni globalmente
        impegniOggi = data.impegni;
        
        // Renderizza impegni
        renderImpegni();
        
        // Prossimi 7 giorni
        const prossimi = $('#prossimi-giorni');
        prossimi.empty();
        
        data.prossimi_7_giorni.forEach(function(giorno) {
            const dataGiorno = new Date(giorno.data);
            const nomeGiorno = giorni[dataGiorno.getDay()].substring(0, 3);
            const isWeekend = dataGiorno.getDay() === 0 || dataGiorno.getDay() === 6;
            const isToday = giorno.data === data.oggi;
            
            let bgClass = 'bg-light';
            let textClass = 'text-dark';
            if (isToday) {
                bgClass = 'bg-primary';
                textClass = 'text-white';
            } else if (isWeekend) {
                bgClass = 'bg-warning bg-opacity-25';
            }
            
            const calendarioUrl = `/calendario/${dataGiorno.getFullYear()}?day=${giorno.data}`;
            const card = `
                <div class="col">
                    <a class="text-decoration-none" href="${calendarioUrl}">
                        <div class="card ${bgClass} border-0 shadow-sm">
                            <div class="card-body p-2 ${textClass}">
                                <div class="fw-bold">${nomeGiorno}</div>
                                <div class="fs-5">${dataGiorno.getDate()}</div>
                                <div class="small">
                                    ${giorno.count > 0 ? `<span class="badge bg-success">${giorno.count}</span>` : '<span class="text-muted">-</span>'}
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            `;
            prossimi.append(card);
        });
    }).fail(function() {
        $('#impegni-oggi-lista').html(`
            <div class="list-group-item text-center text-danger py-5">
                <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                <h5>Errore Caricamento</h5>
                <p>Impossibile caricare i dati della dashboard</p>
            </div>
        `);
    });
    
    // Carica conflitti
    $.getJSON('/api/sovrapposizioni', function(conflitti) {
        const listaConflitti = $('#conflitti-lista');
        listaConflitti.empty();
        
        if (conflitti.length === 0) {
            listaConflitti.append(`
                <div class="list-group-item text-center text-success py-3">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <p class="mb-0 small">Nessun conflitto rilevato</p>
                </div>
            `);
        } else {
            // Mostra primi 5 conflitti
            conflitti.slice(0, 5).forEach(function(conf) {
                const badge = conf.categoria1 === 'ESAME' || conf.categoria2 === 'ESAME' ? 'danger' : 'warning';
                listaConflitti.append(`
                    <div class="list-group-item list-group-item-${badge}">
                        <div class="small fw-bold">${conf.istruttore}</div>
                        <div class="small">${conf.attivita1} vs ${conf.attivita2}</div>
                        <div class="small text-muted">${conf.inizio1} / ${conf.inizio2}</div>
                    </div>
                `);
            });
            
            if (conflitti.length > 5) {
                listaConflitti.append(`
                    <div class="list-group-item text-center">
                        <small class="text-danger fw-bold">+${conflitti.length - 5} altri conflitti!</small>
                    </div>
                `);
            }
        }
    });
});
</script>
{% endblock %}

