{% extends "base.html" %}

{% block title %}Dashboard - Calendario Istruttori{% endblock %}

{% block content %}
<!-- Header Giornaliero -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body text-white py-4">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h2 class="mb-1">üìÖ <span id="data-oggi">Caricamento...</span></h2>
                        <p class="mb-0 opacity-75">Dashboard Operativa Giornaliera</p>
                    </div>
                    <div class="col-md-6">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="bg-white bg-opacity-25 rounded p-2">
                                    <h3 class="mb-0" id="stat-impegni-oggi">-</h3>
                                    <small>Impegni Oggi</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="bg-white bg-opacity-25 rounded p-2">
                                    <h3 class="mb-0" id="stat-corsi-oggi">-</h3>
                                    <small>Corsi Attivi</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="bg-white bg-opacity-25 rounded p-2">
                                    <h3 class="mb-0" id="stat-istruttori-oggi">-</h3>
                                    <small>Istruttori</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Impegni di Oggi -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-white border-bottom">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0"><span id="titolo-impegni">üìã Impegni di Oggi</span></h5>
                    </div>
                    <div class="col-md-6">
                        <select class="form-select form-select-sm" id="filtroCategoria" onchange="filtraPerCategoria()">
                            <option value="">Tutte le categorie</option>
                            <option value="CORSO">Solo Corsi</option>
                            <option value="ESAME">Solo Esami</option>
                            <option value="ADDESTRAMENTO">Solo Addestramento</option>
                            <option value="ASSENZA">Solo Assenze</option>
                            <option value="ALTRO">Altro</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="impegni-oggi-lista" class="list-group list-group-flush">
                    <!-- Popolato via JS -->
                    <div class="list-group-item text-center text-muted py-5">
                        <div style="font-size: 2em;">‚è≥</div>
                        <p>Caricamento impegni...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar Azioni -->
    <div class="col-lg-4">
        <!-- Conflitti -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0">‚ö†Ô∏è Conflitti da Risolvere</h6>
            </div>
            <div class="card-body p-0">
                <div id="conflitti-lista" class="list-group list-group-flush">
                    <div class="list-group-item text-center text-muted">
                        Caricamento...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prossimi 7 Giorni -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0">üóìÔ∏è Prossimi 7 Giorni</h5>
            </div>
            <div class="card-body">
                <div class="row text-center" id="prossimi-giorni">
                    <!-- Popolato via JS -->
                    <div class="col text-muted">Caricamento...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let impegniOggi = []; // Salva tutti gli impegni per filtro
let dataCorrente = null; // Data attualmente visualizzata

function formatData(dataStr) {
    if (!dataStr) return '';
    const iso = String(dataStr).split('T')[0];
    const parts = iso.split('-');
    if (parts.length === 3) {
        const [yyyy, mm, dd] = parts;
        return `${dd.padStart(2,'0')}/${mm.padStart(2,'0')}/${yyyy}`;
    }
    const d = new Date(dataStr);
    const day = String(d.getDate()).padStart(2,'0');
    const mon = String(d.getMonth()+1).padStart(2,'0');
    const yr = String(d.getFullYear());
    return `${day}/${mon}/${yr}`;
}

function normalizeColor(hex) {
    if (!hex) return '#6c757d';
    if (hex.startsWith('#')) return hex;
    return `#${hex}`;
}

function getContrastColor(hex) {
    const color = hex.replace('#', '');
    if (color.length !== 6) return '#ffffff';
    const r = parseInt(color.substr(0, 2), 16);
    const g = parseInt(color.substr(2, 2), 16);
    const b = parseInt(color.substr(4, 2), 16);
    const yiq = (r * 299 + g * 587 + b * 114) / 1000;
    return yiq >= 160 ? '#0f1720' : '#ffffff';
}

function filtraPerCategoria() {
    const categoria = $('#filtroCategoria').val();
    renderImpegni(categoria);
}

function renderImpegni(filtraCategoria = '') {
    const listaImpegni = $('#impegni-oggi-lista');
    listaImpegni.empty();
    
    let impegniFiltrati = impegniOggi;
    if (filtraCategoria) {
        impegniFiltrati = impegniOggi.filter(imp => imp.categoria === filtraCategoria);
    }
    
    if (impegniFiltrati.length === 0) {
        listaImpegni.append(`
            <div class="list-group-item text-center text-muted py-5">
                <div style="font-size: 2em;">üîç</div>
                <h5>Nessun impegno trovato${filtraCategoria ? ' per questa categoria' : ''}!</h5>
            </div>
        `);
        return;
    }
    
    impegniFiltrati.forEach(function(imp) {
        const bg = normalizeColor(imp.colore);
        const textColor = getContrastColor(bg);
        const cursorStyle = imp.id_corso ? 'cursor: pointer;' : '';
        const onclickAttr = imp.id_corso ? `onclick="window.location.href='/corso/${encodeURIComponent(imp.id_corso)}'"` : '';
        const card = `
            <div class="list-group-item list-group-item-action" data-categoria="${imp.categoria}" style="${cursorStyle}" ${onclickAttr}>
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <span class="badge rounded-pill me-2" style="background-color: ${bg}; color: ${textColor}; min-width: 120px;">
                                ${imp.attivita_nome}
                            </span>
                            <strong>${imp.istruttore_nome}</strong>
                        </div>
                        <div class="text-muted small">
                            ${imp.id_corso ? `üéì ${imp.id_corso}` : ''}
                            <span class="ms-2">üìÖ ${formatData(imp.data_inizio)} ‚Üí ${formatData(imp.data_fine)}</span>
                            ${imp.giorni_lavorativi ? `<span class="ms-2">‚è±Ô∏è ${imp.giorni_lavorativi} giorni</span>` : ''}
                        </div>
                        ${imp.note ? `<div class="small mt-1">üìù ${imp.note}</div>` : ''}
                    </div>
                    <div>
                        ${imp.id_corso ? `<span class="text-primary">‚û°Ô∏è</span>` : ''}
                    </div>
                </div>
            </div>
        `;
        listaImpegni.append(card);
    });
}

$(document).ready(function() {
    // Carica dashboard
    $.getJSON('/api/dashboard', function(data) {
        // Header data
        const dataOggi = new Date(data.oggi);
        const giorni = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
        const mesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                      'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        const testoData = `${giorni[dataOggi.getDay()]}, ${dataOggi.getDate()} ${mesi[dataOggi.getMonth()]} ${dataOggi.getFullYear()}`;
        $('#data-oggi').text(testoData);
        
        // Statistiche oggi
        $('#stat-impegni-oggi').text(data.stats.totale_impegni);
        $('#stat-corsi-oggi').text(data.stats.corsi_attivi);
        $('#stat-istruttori-oggi').text(data.stats.istruttori_occupati);
        
        // Salva impegni globalmente
        impegniOggi = data.impegni;
        
        // Renderizza impegni
        renderImpegni();
        
        // Prossimi 7 giorni
        const prossimi = $('#prossimi-giorni');
        prossimi.empty();
        
        data.prossimi_7_giorni.forEach(function(giorno) {
            const dataGiorno = new Date(giorno.data);
            const nomeGiorno = giorni[dataGiorno.getDay()].substring(0, 3);
            const isWeekend = dataGiorno.getDay() === 0 || dataGiorno.getDay() === 6;
            const isToday = giorno.data === data.oggi;
            
            let bgClass = 'bg-light';
            let textClass = 'text-dark';
            if (isToday) {
                bgClass = 'bg-primary';
                textClass = 'text-white';
            } else if (isWeekend) {
                bgClass = 'bg-warning bg-opacity-25';
            }
            
            const card = `
                <div class="col">
                    <div class="card ${bgClass} border-0 shadow-sm" style="cursor: pointer;" onclick="mostraImpegniData('${giorno.data}')">
                        <div class="card-body p-2 ${textClass}">
                            <div class="fw-bold">${nomeGiorno}</div>
                            <div class="fs-5">${dataGiorno.getDate()}</div>
                            <div class="small">
                                ${giorno.count > 0 ? `<span class="badge bg-success">${giorno.count}</span>` : '<span class="text-muted">-</span>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            prossimi.append(card);
        });
    }).fail(function() {
        $('#impegni-oggi-lista').html(`
            <div class="list-group-item text-center text-danger py-5">
                <div style="font-size: 3em;">‚ö†Ô∏è</div>
                <h5>Errore Caricamento</h5>
                <p>Impossibile caricare i dati della dashboard</p>
            </div>
        `);
    });
    
    // Carica conflitti
    $.getJSON('/api/sovrapposizioni', function(conflitti) {
        const listaConflitti = $('#conflitti-lista');
        listaConflitti.empty();
        
        if (conflitti.length === 0) {
            listaConflitti.append(`
                <div class="list-group-item text-center text-success py-3">
                    <div style="font-size: 2em;">‚úÖ</div>
                    <p class="mb-0 small">Nessun conflitto rilevato</p>
                </div>
            `);
        } else {
            conflitti.forEach((c, i) => c._idx = i);
            conflittiCache = conflitti;
            // Mostra primi 5 conflitti
            conflitti.slice(0, 5).forEach(function(conf) {
                const badge = conf.categoria1 === 'ESAME' || conf.categoria2 === 'ESAME' ? 'danger' : 'warning';
                listaConflitti.append(`
                    <div class="list-group-item list-group-item-${badge}">
                        <div class="small fw-bold">${conf.istruttore}</div>
                        <div class="small">${conf.attivita1} vs ${conf.attivita2}</div>
                        <div class="small text-muted">${formatData(conf.inizio1)} / ${formatData(conf.inizio2)}</div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-dark" onclick="apriConflitto(${conf._idx})">
                                Risolvi
                            </button>
                        </div>
                    </div>
                `);
            });
            
            if (conflitti.length > 5) {
                listaConflitti.append(`
                    <div class="list-group-item text-center">
                        <small class="text-danger fw-bold">+${conflitti.length - 5} altri conflitti!</small>
                    </div>
                `);
            }
        }
    });
});

let conflittiCache = [];
let istruttoriCache = [];

// Funzione per mostrare impegni di una data specifica
function mostraImpegniData(data) {
    dataCorrente = data;
    
    // Aggiorna il titolo
    const dataObj = new Date(data);
    const dataFormatted = formatData(data);
    $('#titolo-impegni').text(`üìã Impegni del ${dataFormatted}`);
    
    // Carica impegni per quella data
    $.getJSON(`/api/impegni?data=${data}`, function(impegni) {
        impegniOggi = impegni;
        renderImpegni();
    }).fail(function() {
        $('#impegni-oggi-lista').html(`
            <div class="list-group-item text-center text-danger py-5">
                <span style="font-size: 2em;">‚ö†Ô∏è</span>
                <h5>Errore Caricamento</h5>
                <p>Impossibile caricare gli impegni per questa data</p>
            </div>
        `);
    });
}

function caricaIstruttori() {
    if (istruttoriCache.length > 0) return Promise.resolve(istruttoriCache);
    return $.getJSON('/api/istruttori').then(function(data) {
        istruttoriCache = data || [];
        return istruttoriCache;
    });
}

function apriConflitto(idx) {
    const conf = conflittiCache[idx];
    if (!conf) return;
    const overlapDate = conf.inizio1 > conf.inizio2 ? conf.inizio1 : conf.inizio2;
    caricaIstruttori().then(function() {
        const elencoIstruttori = istruttoriCache
            .filter(i => i.id != conf.istruttore_id)
            .map(i => {
                const nome = `${i.cognome || ''} ${i.nome || ''}`.trim();
                return `<option value="${i.id}">${nome}</option>`;
            }).join('');

        const body = `
            <div class="alert alert-danger">
                ‚ö†Ô∏è
                Conflitto per <strong>${conf.istruttore}</strong>
            </div>
            <div class="mb-2">
                <a class="btn btn-sm btn-outline-secondary" href="/impegni?istruttore=${encodeURIComponent(conf.istruttore)}&data=${overlapDate}">
                    Apri gestione impegni con filtri
                </a>
            </div>
            <div class="mb-2"><strong>Impegni in conflitto:</strong></div>
            <div class="list-group mb-3">
                <label class="list-group-item">
                    <input class="form-check-input me-2" type="radio" name="conflittoImpegno" value="${conf.id1}" checked>
                    <strong>${conf.attivita1}</strong> (${formatData(conf.inizio1)} ‚Üí ${formatData(conf.fine1)})
                </label>
                <label class="list-group-item">
                    <input class="form-check-input me-2" type="radio" name="conflittoImpegno" value="${conf.id2}">
                    <strong>${conf.attivita2}</strong> (${formatData(conf.inizio2)} ‚Üí ${formatData(conf.fine2)})
                </label>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data conflitto</label>
                    <input type="date" class="form-control" id="conflittoData" value="${overlapDate}">
                    <small class="text-muted">Data usata per la sostituzione</small>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Sostituto</label>
                    <select class="form-select" id="conflittoSostituto">
                        <option value="">Seleziona...</option>
                        ${elencoIstruttori}
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Sposta impegno di (giorni lavorativi)</label>
                    <input type="number" class="form-control" id="conflittoShiftDays" min="1" value="1">
                </div>
            </div>
        `;
        $('#modalConflittoHomeBody').html(body);
        $('#btnRisolviSostituzione').off('click').on('click', function() {
            risolviConflittoSostituzione(conf.istruttore_id);
        });
        $('#btnRisolviSpostamento').off('click').on('click', function() {
            risolviConflittoSpostamento();
        });
        new bootstrap.Modal($('#modalConflittoHome')).show();
    });
}

function getImpegnoSelezionato() {
    return $('input[name="conflittoImpegno"]:checked').val();
}

async function risolviConflittoSostituzione(istruttoreId) {
    const impegnoId = getImpegnoSelezionato();
    const sostId = $('#conflittoSostituto').val();
    const dataStr = $('#conflittoData').val();
    if (!impegnoId || !sostId || !dataStr) {
        alert('Seleziona impegno, sostituto e data.');
        return;
    }
    try {
        const res = await fetch('/api/sostituzioni', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                impegno_id: Number(impegnoId),
                istruttore_originale_id: Number(istruttoreId),
                istruttore_sostituto_id: Number(sostId),
                data_sostituzione: dataStr,
                note: 'Risoluzione conflitto da home page'
            })
        });
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            alert(`Errore: ${res.status} ${err.messaggio || err.message || err.error || ''}`);
            return;
        }
        new bootstrap.Modal($('#modalConflittoHome')).hide();
        location.reload();
    } catch (e) {
        alert('Errore di rete nella sostituzione');
    }
}

async function risolviConflittoSpostamento() {
    const impegnoId = getImpegnoSelezionato();
    const days = parseInt($('#conflittoShiftDays').val() || '0', 10);
    if (!impegnoId || !days || days < 1) {
        alert('Seleziona impegno e inserisci giorni validi.');
        return;
    }
    try {
        const res = await fetch(`/api/impegni/${impegnoId}/shift`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ days })
        });
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            alert(`Errore: ${res.status} ${err.messaggio || err.error || ''}`);
            return;
        }
        new bootstrap.Modal($('#modalConflittoHome')).hide();
        location.reload();
    } catch (e) {
        alert('Errore di rete nello spostamento');
    }
}
</script>
<!-- Modal Risoluzione Conflitto Home -->
<div class="modal fade" id="modalConflittoHome" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">‚ö†Ô∏è Risolvi Conflitto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalConflittoHomeBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" id="btnRisolviSpostamento">
                    Sposta Impegno
                </button>
                <button type="button" class="btn btn-primary" id="btnRisolviSostituzione">
                    Sostituisci Giorno
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

