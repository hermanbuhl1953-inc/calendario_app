{% extends "base.html" %}

{% block title %}Vista Corsi - Calendario Istruttori{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>üìö Gestione Corsi</h2>
        <p class="text-muted">Gestisci i corsi, visualizza e modifica i calendari con tutti gli istruttori coinvolti</p>
        <hr>
    </div>
</div>

<!-- Barra Ricerca -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text">üîç</span>
            <input type="text" class="form-control" id="cercaCorso" 
                   placeholder="Cerca per ID corso...">
        </div>
    </div>
    <div class="col-md-3">
        <input type="date" class="form-control" id="filtroDa" placeholder="Data da">
    </div>
    <div class="col-md-3">
        <input type="date" class="form-control" id="filtroA" placeholder="Data a">
    </div>
</div>

{% if corsi %}
<div class="row">
    <div class="col-12">
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>ID Corso</th>
                        <th>Periodo</th>
                        <th>Durata</th>
                        <th>N¬∞ Istruttori</th>
                        <th>N¬∞ Impegni</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for corso in corsi %}
                    <tr>
                        <td><strong>{{ corso.id_corso }}</strong></td>
                        <td>
                            <i class="fas fa-calendar-day"></i> 
                            {{ corso.data_inizio|itdate }}
                            ‚Üí
                            {{ corso.data_fine|itdate }}
                        </td>
                        <td>
                            {% set inizio = corso.data_inizio %}
                            {% set fine = corso.data_fine %}
                            {% set giorni = ((fine | string | replace('-', '') | int) - (inizio | string | replace('-', '') | int)) %}
                            {{ ((fine.split('-')[0] | int - inizio.split('-')[0] | int) * 365 + 
                                (fine.split('-')[1] | int - inizio.split('-')[1] | int) * 30 + 
                                (fine.split('-')[2] | int - inizio.split('-')[2] | int) + 1) }} giorni
                        </td>
                        <td>
                            <span class="badge bg-info">{{ corso.num_istruttori }} istruttori</span>
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ corso.num_impegni }} impegni</span>
                        </td>
                        <td>
                            <a href="/corso/{{ corso.id_corso }}" class="btn btn-sm btn-primary me-1">
                                üìÖ Vedi Calendario
                            </a>
                            <button class="btn btn-sm btn-success" onclick="modificaCorso('{{ corso.id_corso }}')">
                                ‚úèÔ∏è Modifica
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> 
            <strong>Nessun corso trovato</strong><br>
            Non ci sono corsi registrati con un ID Corso. Aggiungi impegni con un ID Corso per vederli qui.
        </div>
    </div>
</div>
{% endif %}

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <span style="font-size: 1.2em;">‚ÑπÔ∏è</span> Come funziona?
            </div>
            <div class="card-body">
                <ol>
                    <li>Ogni corso √® identificato da un <strong>ID Corso</strong> univoco (es. 01_25, CORSO_A, etc.)</li>
                    <li>Un corso pu√≤ avere <strong>pi√π impegni</strong> con diversi istruttori e attivit√†</li>
                    <li>Clicca su <strong>"Vedi Calendario"</strong> per vedere il calendario del corso</li>
                    <li>Clicca su <strong>"Modifica"</strong> per aggiornare i dettagli del corso</li>
                    <li>Nel calendario vedrai:
                        <ul>
                            <li>Tutte le attivit√† del corso giorno per giorno</li>
                            <li>Chi sta facendo cosa in ogni giorno</li>
                            <li>Le sostituzioni eventualmente presenti</li>
                        </ul>
                    </li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modifica Corso -->
<div class="modal fade" id="modalModificaCorso" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">‚úèÔ∏è Modifica Calendario Corso: <span id="corsoTitolo"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <strong>‚ö†Ô∏è Nota:</strong> Da questa pagina puoi modificare i dettagli del corso (date, istruttori, attivit√†, sedi, aule, partecipanti).
                    Per registrare le assenze degli istruttori, usa la pagina "Assenze".
                </div>
                
                <ul class="nav nav-tabs mb-3" id="tabsModificaCorso" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-info" data-bs-toggle="tab" data-bs-target="#pane-info" type="button">‚ÑπÔ∏è Informazioni Corso</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-impegni" data-bs-toggle="tab" data-bs-target="#pane-impegni" type="button">üìã Impegni</button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- TAB 1: Info Corso -->
                    <div class="tab-pane fade show active" id="pane-info" role="tabpanel">
                        <form id="formInfoCorso">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">ID Corso *</label>
                                    <input type="text" class="form-control" id="mod_id_corso" readonly>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Data Inizio *</label>
                                    <input type="date" class="form-control" id="mod_data_inizio" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Data Fine *</label>
                                    <input type="date" class="form-control" id="mod_data_fine" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Luogo</label>
                                    <select class="form-select" id="mod_luogo">
                                        <option value="">-</option>
                                        <option value="CADORNA">CADORNA</option>
                                        <option value="CAMNAGO">CAMNAGO</option>
                                        <option value="FIORENZA">FIORENZA</option>
                                        <option value="GARIBALDI">GARIBALDI</option>
                                        <option value="NOVATE">NOVATE</option>
                                        <option value="ALTRO">ALTRO</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Aula</label>
                                    <input type="text" class="form-control" id="mod_aula" placeholder="Es. Aula 3">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">N¬∞ Partecipanti</label>
                                    <input type="number" class="form-control" id="mod_posti" min="1" placeholder="Es. 25">
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- TAB 2: Impegni -->
                    <div class="tab-pane fade" id="pane-impegni" role="tabpanel">
                        <div class="alert alert-warning">
                            <small>Gli impegni sono i singoli insegnamenti/esami che compongono il corso. Ogni istruttore ha una o pi√π attivit√† assegnate.</small>
                        </div>
                        <div id="listaImpegniModifica">
                            <p class="text-muted">Caricamento...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-success" onclick="salvaModificheCorso()">üíæ Salva Modifiche</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modifica Impegno -->
<div class="modal fade" id="modalModificaImpegno" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">‚úèÔ∏è Modifica Impegno</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formModificaImpegno">
                    <input type="hidden" id="mod_imp_id">
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">ID Corso</label>
                            <input type="text" class="form-control" id="mod_imp_id_corso" readonly>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Istruttore *</label>
                            <select class="form-select" id="mod_imp_istruttore_id" required>
                                <option value="">Caricamento...</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Attivit√† *</label>
                            <select class="form-select" id="mod_imp_attivita_id" required>
                                <option value="">Caricamento...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Data Inizio *</label>
                            <input type="date" class="form-control" id="mod_imp_data_inizio" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Data Fine</label>
                            <input type="date" class="form-control" id="mod_imp_data_fine">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Giorni Lavorativi</label>
                            <input type="number" class="form-control" id="mod_imp_giorni_lavorativi" min="1">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Note</label>
                        <textarea class="form-control" id="mod_imp_note" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-warning" onclick="salvaModificaImpegno()">üíæ Salva</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // Ricerca real-time
    $('#cercaCorso, #filtroDa, #filtroA').on('input change', function() {
        applicaFiltriCorsi();
    });
});

function applicaFiltriCorsi() {
    const ricerca = $('#cercaCorso').val().toLowerCase();
    const dataDa = $('#filtroDa').val();
    const dataA = $('#filtroA').val();
    
    $('tbody tr').each(function() {
        const row = $(this);
        const idCorso = row.find('td:eq(0)').text().toLowerCase();
        const periodo = row.find('td:eq(1)').text();
        
        let mostra = true;
        
        // Filtro ricerca ID corso
        if (ricerca && !idCorso.includes(ricerca)) {
            mostra = false;
        }
        
        // Filtro data: estrai dd/mm/yyyy dal testo e confronta con input ISO
        if (dataDa || dataA) {
            const match = periodo.match(/(\d{2}\/\d{2}\/\d{4})/g);
            if (match && match.length >= 2) {
                const toIso = (d) => { const [dd, mm, yyyy] = d.split('/'); return `${yyyy}-${mm}-${dd}`; };
                const inizio = toIso(match[0]);
                const fine = toIso(match[1]);
                if (dataDa && fine < dataDa) mostra = false;
                if (dataA && inizio > dataA) mostra = false;
            }
        }
        
        row.toggle(mostra);
    });
}

// ============================================================================
// MODIFICA CORSO
// ============================================================================

let modalModificaInstance = null;
let modalModificaImpegnoInstance = null;

$(document).ready(function() {
    modalModificaInstance = new bootstrap.Modal($('#modalModificaCorso')[0]);
    modalModificaImpegnoInstance = new bootstrap.Modal($('#modalModificaImpegno')[0]);
});

function modificaCorso(idCorso) {
    // Carica i dati del corso
    $.getJSON(`/api/corsi/${encodeURIComponent(idCorso)}`, function(data) {
        if (!data || data.length === 0) {
            alert('Corso non trovato!');
            return;
        }
        
        const primo = data[0];  // Prendi il primo impegno come reference
        
        // Popola il form info
        $('#corsoTitolo').text(idCorso);
        $('#mod_id_corso').val(idCorso);
        $('#mod_data_inizio').val(primo.data_inizio);
        $('#mod_data_fine').val(primo.data_fine);
        $('#mod_luogo').val(primo.luogo || '');
        $('#mod_aula').val(primo.aula || '');
        $('#mod_posti').val(primo.posti || '');
        
        // Popola la lista impegni
        const lista = $('#listaImpegniModifica');
        lista.empty();
        
        if (data.length === 0) {
            lista.html('<p class="text-muted">Nessun impegno trovato per questo corso</p>');
        } else {
            data.forEach((imp, idx) => {
                const html = `
                    <div class="card mb-2">
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>${imp.istruttore_nome || 'N/A'}</strong>
                                    <br><small class="text-muted">Istruttore</small>
                                </div>
                                <div class="col-md-3">
                                    <strong>${imp.attivita_nome || 'N/A'}</strong>
                                    <br><small class="text-muted">Attivit√†</small>
                                </div>
                                <div class="col-md-3">
                                    <strong>${imp.data_inizio} ‚Üí ${imp.data_fine}</strong>
                                    <br><small class="text-muted">Periodo</small>
                                </div>
                                <div class="col-md-3 text-end">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="modificaImpegno(${imp.id})">
                                        ‚úèÔ∏è Modifica
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                lista.append(html);
            });
        }
        
        // Apri modale
        modalModificaInstance.show();
    }).fail(function(xhr) {
        alert('Errore nel caricare i dati del corso: ' + (xhr.status || 'Sconosciuto'));
    });
}

function modificaImpegno(idImpegno) {
    // Carica i dati dell'impegno E i dropdown di istruttori/attivit√†
    Promise.all([
        $.getJSON('/api/impegni'),
        $.getJSON('/api/istruttori'),
        $.getJSON('/api/tipi-attivita')
    ]).then(function([impegni, istruttori, attivita]) {
        const impegno = impegni.find(i => i.id === idImpegno);
        if (!impegno) {
            alert('Impegno non trovato!');
            return;
        }
        
        // Popola dropdown istruttori
        const selectIstr = $('#mod_imp_istruttore_id');
        selectIstr.empty().append('<option value="">Seleziona...</option>');
        istruttori.forEach(istr => {
            selectIstr.append(`<option value="${istr.id}">${istr.nome}</option>`);
        });
        selectIstr.val(impegno.istruttore_id);
        
        // Popola dropdown attivit√†
        const selectAtt = $('#mod_imp_attivita_id');
        selectAtt.empty().append('<option value="">Seleziona...</option>');
        attivita.forEach(att => {
            selectAtt.append(`<option value="${att.id}">${att.nome}</option>`);
        });
        selectAtt.val(impegno.attivita_id);
        
        // Popola il resto del form
        $('#mod_imp_id').val(impegno.id);
        $('#mod_imp_id_corso').val(impegno.id_corso || '');
        $('#mod_imp_data_inizio').val(impegno.data_inizio);
        $('#mod_imp_data_fine').val(impegno.data_fine || '');
        $('#mod_imp_giorni_lavorativi').val(impegno.giorni_lavorativi || '');
        $('#mod_imp_note').val(impegno.note || '');
        
        // Mostra modale
        modalModificaImpegnoInstance.show();
    }).catch(function() {
        alert('Errore nel caricare i dati!');
    });
}

function salvaModificaImpegno() {
    const impegnoId = $('#mod_imp_id').val();
    const istruttoreId = $('#mod_imp_istruttore_id').val();
    const attivitaId = $('#mod_imp_attivita_id').val();
    const dataInizio = $('#mod_imp_data_inizio').val();
    const dataFine = $('#mod_imp_data_fine').val();
    const giorniLavorativi = $('#mod_imp_giorni_lavorativi').val();
    const note = $('#mod_imp_note').val();
    const idCorso = $('#mod_imp_id_corso').val();
    
    if (!istruttoreId || !attivitaId || !dataInizio) {
        alert('Compila i campi obbligatori!');
        return;
    }
    
    const data = {
        istruttore_id: parseInt(istruttoreId),
        attivita_id: parseInt(attivitaId),
        data_inizio: dataInizio,
        data_fine: dataFine || null,
        giorni_lavorativi: giorniLavorativi ? parseInt(giorniLavorativi) : null,
        note: note
    };
    
    $.ajax({
        url: `/api/impegni/${impegnoId}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function() {
            alert('Impegno modificato con successo!');
            modalModificaImpegnoInstance.hide();
            // Ricarica i dati del corso
            if (idCorso) {
                modificaCorso(idCorso);
            }
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON?.error || 'Errore sconosciuto';
            alert('Errore nel salvare l\'impegno: ' + errorMsg);
        }
    });
}

function salvaModificheCorso() {
    const idCorso = $('#mod_id_corso').val();
    const dataInizio = $('#mod_data_inizio').val();
    const dataFine = $('#mod_data_fine').val();
    const luogo = $('#mod_luogo').val();
    const aula = $('#mod_aula').val();
    const posti = $('#mod_posti').val();
    
    if (!idCorso || !dataInizio || !dataFine) {
        alert('Compila i campi obbligatori!');
        return;
    }
    
    if (dataInizio > dataFine) {
        alert('La data di inizio deve essere prima della data di fine!');
        return;
    }
    
    $.ajax({
        url: '/api/corsi/aggiorna',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            id_corso: idCorso,
            data_inizio: dataInizio,
            data_fine: dataFine,
            luogo: luogo || null,
            aula: aula || null,
            posti: posti || null
        }),
        success: function() {
            alert('Corso modificato con successo!');
            modalModificaInstance.hide();
            // Ricarica i dati dalla tabella senza ricaricare tutta la pagina
            location.reload();
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON?.error || 'Errore sconosciuto';
            console.error('Errore aggiorna_corso:', errorMsg);
            alert('Errore nel salvare le modifiche: ' + errorMsg);
        }
    });
}
</script>
{% endblock %}
<html xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882"><head>
<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:xd_Signature msdt:dt="string"></mso:xd_Signature>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor msdt:dt="string">Grifasi Angelo Giuseppe</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor>
<mso:Order msdt:dt="string">193100.000000000</mso:Order>
<mso:ComplianceAssetId msdt:dt="string"></mso:ComplianceAssetId>
<mso:TemplateUrl msdt:dt="string"></mso:TemplateUrl>
<mso:xd_ProgID msdt:dt="string"></mso:xd_ProgID>
<mso:_ExtendedDescription msdt:dt="string"></mso:_ExtendedDescription>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author msdt:dt="string">Grifasi Angelo Giuseppe</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author>
<mso:TriggerFlowInfo msdt:dt="string"></mso:TriggerFlowInfo>
<mso:ContentTypeId msdt:dt="string">0x0101002AC836DBC1B2D14B9CF1B153B23CAC72</mso:ContentTypeId>
<mso:_SourceUrl msdt:dt="string"></mso:_SourceUrl>
<mso:_SharedFileIndex msdt:dt="string"></mso:_SharedFileIndex>
<mso:TaxCatchAll msdt:dt="string"></mso:TaxCatchAll>
<mso:MediaServiceImageTags msdt:dt="string"></mso:MediaServiceImageTags>
<mso:lcf76f155ced4ddcb4097134ff3c332f msdt:dt="string"></mso:lcf76f155ced4ddcb4097134ff3c332f>
</mso:CustomDocumentProperties>
</xml><![endif]-->
<title></title></head>