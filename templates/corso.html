{% extends "base.html" %}

{% block title %}Corso {{ id_corso }} - Calendario Istruttori{% endblock %}

{% block extra_head %}
<style>
.calendario-corso {
    overflow-x: auto;
    margin-top: 20px;
}

.calendario-corso table {
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.75rem;
}

.calendario-corso th,
.calendario-corso td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
    min-width: 80px;
    height: 60px;
    vertical-align: middle;
}

.calendario-corso thead th {
    background-color: #34495E;
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
    font-size: 0.7rem;
}

.calendario-corso tbody th {
    background-color: #ECF0F1;
    position: sticky;
    left: 0;
    z-index: 5;
    font-weight: bold;
    text-align: left;
    padding-left: 12px;
    min-width: 150px;
}

.cella-corso {
    cursor: pointer;
    transition: all 0.2s;
    color: white;
    font-weight: bold;
    font-size: 0.65rem;
    line-height: 1.2;
}

.cella-corso:hover {
    opacity: 0.8;
    transform: scale(1.05);
    box-shadow: 0 0 8px rgba(0,0,0,0.3);
}

.cella-vuota {
    background-color: white;
}

.giorno-weekend {
    background-color: #f8f9fa;
}

.weekend-header {
    background-color: #95a5a6 !important;
    color: white !important;
}

.istruttore-nome {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.attivita-nome-cella {
    display: block;
    font-size: 0.6rem;
    margin-top: 2px;
}

/* Celle con conflitto (più attività nello stesso giorno per lo stesso istruttore) */
.cella-conflitto {
    background-color: #ffe5e5;
    border: 2px solid #dc3545 !important;
    color: #222 !important;
    position: relative;
}

.conflitto-badge {
    position: absolute;
    top: 2px;
    right: 2px;
    background: #dc3545;
    color: #fff;
    font-size: 0.55rem;
    padding: 2px 4px;
    border-radius: 4px;
}

.stack-badge {
    display: inline-block;
    padding: 2px 4px;
    font-size: 0.55rem;
    border-radius: 4px;
    margin: 1px;
    color: #fff;
    font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <a href="/vista_corsi" class="btn btn-secondary mb-3">
            <i class="fas fa-arrow-left"></i> Torna a Vista Corsi
        </a>
        <button class="btn btn-primary mb-3 ms-2" data-bs-toggle="modal" data-bs-target="#modalNuovoImpegno">
            <i class="fas fa-plus"></i> Aggiungi Attività
        </button>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h3><i class="fas fa-graduation-cap"></i> CORSO {{ id_corso }}</h3>
            </div>
            <div class="card-body">
                <!-- Info Riepilogo -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="fas fa-calendar-day"></i> Periodo</h6>
                                <p class="mb-1"><strong>Inizio:</strong> {{ data_inizio|itdate }}</p>
                                <p class="mb-0"><strong>Fine:</strong> {{ data_fine|itdate }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="fas fa-clock"></i> Durata</h6>
                                <p class="mb-1"><strong>Totale:</strong> {{ num_giorni }} giorni</p>
                                <p class="mb-0"><strong>Lavorativi:</strong> {{ impegni|sum(attribute='giorni_lavorativi') }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="fas fa-users"></i> Istruttori</h6>
                                <p class="mb-0"><strong>N° Impegni:</strong> {{ impegni|length }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendario Visivo -->
                <h5><i class="fas fa-calendar-alt"></i> Calendario Corso - Chi fa Cosa</h5>
                <div class="calendario-corso">
                    <table>
                        <thead>
                            <tr>
                                <th>Istruttore / Giorno</th>
                                {% for giorno in giorni %}
                                <th class="{% if giorno.giorno_settimana in ['Sab', 'Dom'] %}weekend-header{% endif %}">
                                    {{ giorno.giorno }}<br>
                                    <small>{{ giorno.giorno_settimana }}</small>
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for ist in istruttori_unici %}
                            <tr>
                                <th class="istruttore-nome">{{ ist.nome }}</th>
                                {% for giorno in giorni %}
                                <td id="cella-{{ ist.id }}-{{ giorno.indice }}"
                                    class="cella-vuota {% if giorno.giorno_settimana in ['Sab', 'Dom'] %}giorno-weekend{% endif %}">
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Timeline Attività -->
                <div class="mt-5">
                    <h5><i class="fas fa-timeline"></i> Timeline Attività</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Istruttore</th>
                                    <th>Data Inizio</th>
                                    <th>Data Fine</th>
                                    <th>Attività</th>
                                    <th>Giorni Lavorativi</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for imp in impegni %}
                                <tr>
                                    <td>{{ imp.istruttore_nome }}</td>
                                    <td>{{ imp.data_inizio|itdate }}</td>
                                    <td>{{ imp.data_fine|itdate }}</td>
                                    <td>
                                        <span class="badge" style="background-color: #{{ imp.colore }};">
                                            {{ imp.attivita_nome }}
                                        </span>
                                    </td>
                                    <td>{{ imp.giorni_lavorativi }}</td>
                                    <td>{{ imp.note or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-info">
                                    <td colspan="4"><strong>TOTALE GIORNI LAVORATIVI</strong></td>
                                    <td><strong>{{ impegni|sum(attribute='giorni_lavorativi') }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Dettaglio -->
<div class="modal fade" id="modalDettaglio" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dettaglio Attività</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDettaglioBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Conflitto -->
<div class="modal fade" id="modalConflitto" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-danger"></i> Conflitto attività</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalConflittoBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
    </div>

<!-- Modal Nuovo Impegno -->
<div class="modal fade" id="modalNuovoImpegno" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Aggiungi Attività al Corso</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNuovoImpegno">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Istruttore *</label>
                            <select class="form-select" id="nuovoIstruttoreId" required>
                                <option value="">Seleziona...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Attività *</label>
                            <select class="form-select" id="nuovoAttivitaId" required>
                                <option value="">Seleziona...</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Data Inizio *</label>
                            <input type="date" class="form-control" id="nuovoDataInizio" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Giorni Lavorativi *</label>
                            <input type="number" class="form-control" id="nuovoGiorniLav" min="1" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Data Fine (calcolata)</label>
                            <input type="date" class="form-control" id="nuovoDataFine" disabled>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Note</label>
                        <textarea class="form-control" id="nuovoNote" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" onclick="salvaNuovoImpegno()">
                    <i class="fas fa-save"></i> Salva
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const impegni = {{ impegni|tojson }};
const sostituzioni = {{ sostituzioni|tojson }};
const giorni = {{ giorni|tojson }};
const dataInizioCorso = '{{ data_inizio }}';
const istruttoriUnici = {{ istruttori_unici|tojson }};

$(document).ready(function() {
    popolaCalendarioCorso();
});

function popolaCalendarioCorso() {
    const corsoInizio = new Date(dataInizioCorso);
    const occupazioniCelle = {}; // key: `${istruttoreId}-${giornoIndice}` -> array di {imp, dataStr}

    // Accumula occupazioni per giorno/istruttore
    impegni.forEach(imp => {
        const dataInizio = new Date(imp.data_inizio);
        const dataFine = new Date(imp.data_fine);

        const giorniExtra = new Set();
        if (imp.giorno_extra_1) giorniExtra.add(imp.giorno_extra_1);
        if (imp.giorno_extra_2) giorniExtra.add(imp.giorno_extra_2);
        if (imp.giorno_extra_3) giorniExtra.add(imp.giorno_extra_3);

        for (let d = new Date(dataInizio); d <= dataFine; d.setDate(d.getDate() + 1)) {
            const dataGiornoStr = d.toISOString().split('T')[0];
            const weekday = d.getDay(); // 0=Dom, 1=Lun, ..., 6=Sab
            const isLunVen = weekday >= 1 && weekday <= 5;
            const isGiornoExtra = giorniExtra.has(dataGiornoStr);
            if (!(isLunVen || isGiornoExtra)) continue;

            const giornoIndice = Math.floor((d - corsoInizio) / (1000 * 60 * 60 * 24)) + 1;
            const key = `${imp.istruttore_id}-${giornoIndice}`;
            if (!occupazioniCelle[key]) occupazioniCelle[key] = [];
            occupazioniCelle[key].push({ imp, dataStr: dataGiornoStr });
        }
    });

    // Renderizza celle in base alle occupazioni
    Object.entries(occupazioniCelle).forEach(([key, items]) => {
        const [istrId, giornoIndice] = key.split('-');
        const cella = $(`#cella-${istrId}-${giornoIndice}`);
        if (!cella.length) return;

        cella.removeClass('cella-vuota giorno-weekend');

        if (items.length === 1) {
            const { imp, dataStr } = items[0];
            cella.addClass('cella-corso');
            cella.css('background-color', `#${imp.colore}`);
            cella.html(`
                <div class="istruttore-nome">${imp.istruttore_nome.split(' ')[0]}</div>
                <div class="attivita-nome-cella">${imp.attivita_nome.substring(0, 15)}</div>
            `);
            cella.off('click').on('click', function() { mostraDettaglio(imp, dataStr); });
        } else {
            // Conflitto: più attività nello stesso giorno
            cella.addClass('cella-conflitto');
            cella.html(`
                <div>
                    ${items.map(({ imp }) => `<span class="stack-badge" style="background-color:#${imp.colore}">${imp.attivita_nome.substring(0,10)}</span>`).join('')}
                </div>
                <span class="conflitto-badge">${items.length}×</span>
            `);
            cella.off('click').on('click', function() { mostraConflitto(istrId, giornoIndice, items); });
        }
    });

    // Applica sostituzioni (sovrascrive la cella del giorno puntuale)
    sostituzioni.forEach(sost => {
        const dataSost = new Date(sost.data_sostituzione);
        const giornoIndice = Math.floor((dataSost - corsoInizio) / (1000 * 60 * 60 * 24)) + 1;
        const impOriginal = impegni.find(i => i.id === sost.impegno_id);
        if (!impOriginal) return;

        const cellaOrig = $(`#cella-${sost.istruttore_originale_id}-${giornoIndice}`);
        if (cellaOrig.length) {
            cellaOrig.addClass('cella-vuota').removeClass('cella-corso cella-conflitto');
            cellaOrig.css('background-color', 'white').html('').off('click');
        }

        const cellaSost = $(`#cella-${sost.istruttore_sostituto_id}-${giornoIndice}`);
        if (cellaSost.length) {
            cellaSost.removeClass('cella-vuota giorno-weekend');
            cellaSost.addClass('cella-corso');
            cellaSost.css('background-color', `#${sost.colore}`);
            cellaSost.html(`
                <div class="istruttore-nome">${sost.istruttore_sostituto.split(' ')[0]}</div>
                <div class="attivita-nome-cella">${sost.attivita_nome.substring(0, 15)}</div>
                <small><i class="fas fa-exchange-alt"></i></small>
            `);
            cellaSost.off('click').on('click', function() { mostraDettaglioSostituzione(impOriginal, sost); });
        }
    });
}

function mostraDettaglio(impegno, data) {
    const html = `
        <p><strong>Data:</strong> ${formatData(data)}</p>
        <p><strong>Istruttore:</strong> ${impegno.istruttore_nome}</p>
        <p><strong>Attività:</strong> 
            <span class="badge" style="background-color: #${impegno.colore};">
                ${impegno.attivita_nome}
            </span>
        </p>
        <p><strong>Periodo Impegno:</strong> ${formatData(impegno.data_inizio)} → ${formatData(impegno.data_fine)}</p>
        <p><strong>Giorni Lavorativi:</strong> ${impegno.giorni_lavorativi}</p>
        ${impegno.note ? `<p><strong>Note:</strong> ${impegno.note}</p>` : ''}
    `;
    
    $('#modalDettaglioBody').html(html);
    new bootstrap.Modal($('#modalDettaglio')).show();
}

function mostraDettaglioSostituzione(impegno, sost) {
    const html = `
        <div class="alert alert-info">
            <i class="fas fa-exchange-alt"></i> <strong>SOSTITUZIONE</strong>
        </div>
        <p><strong>Data:</strong> ${formatData(sost.data_sostituzione)}</p>
        <p><strong>Istruttore Originale:</strong> ${sost.istruttore_originale}</p>
        <p><strong>Istruttore Sostituto:</strong> ${sost.istruttore_sostituto}</p>
        <p><strong>Attività:</strong> 
            <span class="badge" style="background-color: #${sost.colore};">
                ${sost.attivita_nome}
            </span>
        </p>
        ${sost.note ? `<p><strong>Motivo:</strong> ${sost.note}</p>` : ''}
    `;
    
    $('#modalDettaglioBody').html(html);
    new bootstrap.Modal($('#modalDettaglio')).show();
}

function formatData(dataStr) {
    if (!dataStr) return '';
    const iso = String(dataStr).split('T')[0];
    const parts = iso.split('-');
    if (parts.length === 3) {
        const [yyyy, mm, dd] = parts;
        return `${dd.padStart(2,'0')}/${mm.padStart(2,'0')}/${yyyy}`;
    }
    const d = new Date(dataStr);
    const day = String(d.getDate()).padStart(2,'0');
    const mon = String(d.getMonth()+1).padStart(2,'0');
    const yr = String(d.getFullYear());
    return `${day}/${mon}/${yr}`;
}

function mostraConflitto(istrId, giornoIndice, items) {
    const dataStr = giorni[giornoIndice - 1].data;
    const istrNome = (istruttoriUnici.find(i => i.id == istrId) || {}).nome || 'Istruttore';
    const elenco = items.map(({ imp }) => `
        <div class="d-flex align-items-center justify-content-between border rounded p-2 mb-2">
            <div>
                <div><strong>${imp.attivita_nome}</strong> <span class="badge" style="background-color:#${imp.colore}">${imp.attivita_nome.substring(0,10)}</span></div>
                <small>Impegno: ${formatData(imp.data_inizio)} → ${formatData(imp.data_fine)} (ID ${imp.id})</small>
            </div>
            <div class="d-flex gap-2">
                <select class="form-select form-select-sm" data-role="sost-${imp.id}" style="min-width:180px">
                    <option value="">Seleziona sostituto…</option>
                    ${istruttoriUnici.filter(x => x.id != istrId).map(x => `<option value="${x.id}">${x.nome}</option>`).join('')}
                </select>
                <button class="btn btn-sm btn-primary" onclick="risolviConSostituzione(${imp.id}, ${istrId}, '${dataStr}')">
                    Sostituisci questo giorno
                </button>
                <div class="input-group input-group-sm" style="width: 180px;">
                    <span class="input-group-text">Sposta +</span>
                    <input type="number" class="form-control" min="1" value="1" data-role="shift-${imp.id}">
                    <button class="btn btn-outline-primary" onclick="risolviConSpostamento(${imp.id})">OK</button>
                </div>
            </div>
        </div>
    `).join('');

    const html = `
        <div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${istrNome} ha ${items.length} attività sovrapposte in data ${formatData(dataStr)}.</div>
        ${elenco}
        <div class="mt-2">
            <a class="btn btn-outline-secondary btn-sm" href="/impegni?istruttore=${encodeURIComponent(istrNome)}&data=${dataStr}">
                Apri gestione impegni con filtri
            </a>
        </div>
    `;
    $('#modalConflittoBody').html(html);
    new bootstrap.Modal($('#modalConflitto')).show();
}

async function risolviConSostituzione(impegnoId, istruttoreOriginaleId, dataStr) {
    const select = document.querySelector(`select[data-role="sost-${impegnoId}"]`);
    const sostId = select ? select.value : '';
    if (!sostId) { alert('Seleziona un istruttore sostituto.'); return; }

    const body = {
        impegno_id: impegnoId,
        istruttore_originale_id: istruttoreOriginaleId,
        istruttore_sostituto_id: Number(sostId),
        data_sostituzione: dataStr,
        note: 'Risoluzione conflitto da pagina corso'
    };

    try {
        const res = await fetch('/api/sostituzioni', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            alert(`Errore: ${res.status} ${err.message || ''}`);
            return;
        }
        // Aggiorna ricaricando la pagina per riflettere nuove sostituzioni
        new bootstrap.Modal($('#modalConflitto')).hide();
        location.reload();
    } catch (e) {
        alert('Errore di rete nella creazione sostituzione');
    }
}

async function risolviConSpostamento(impegnoId) {
    const input = document.querySelector(`input[data-role="shift-${impegnoId}"]`);
    const days = input ? parseInt(input.value || '0', 10) : 0;
    if (!days || days < 1) { alert('Inserisci un numero di giorni valido'); return; }
    try {
        const res = await fetch(`/api/impegni/${impegnoId}/shift`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ days })
        });
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            alert(`Errore: ${res.status} ${err.messaggio || err.error || ''}`);
            return;
        }
        new bootstrap.Modal($('#modalConflitto')).hide();
        location.reload();
    } catch (e) {
        alert('Errore di rete nello spostamento impegno');
    }
}

// --- Nuovo Impegno Modal ---
$(document).ready(function() {
    caricaIstruttoriAttivita();
    
    // Auto-calcola data fine quando cambiano data inizio o giorni lavorativi
    $('#nuovoDataInizio, #nuovoGiorniLav').on('change', function() {
        calcolaDataFineNuovoImpegno();
    });
});

async function caricaIstruttoriAttivita() {
    try {
        const [istruttoriRes, attivitaRes] = await Promise.all([
            fetch('/api/istruttori'),
            fetch('/api/tipi-attivita')
        ]);
        
        if (istruttoriRes.ok) {
            const istruttori = await istruttoriRes.json();
            const select = $('#nuovoIstruttoreId');
            istruttori.forEach(i => {
                select.append(`<option value="${i.id}">${i.cognome} ${i.nome}</option>`);
            });
        }
        
        if (attivitaRes.ok) {
            const attivita = await attivitaRes.json();
            const select = $('#nuovoAttivitaId');
            attivita.forEach(a => {
                select.append(`<option value="${a.id}">${a.nome}</option>`);
            });
        }
    } catch (e) {
        console.error('Errore caricamento istruttori/attività:', e);
    }
}

async function calcolaDataFineNuovoImpegno() {
    const dataInizio = $('#nuovoDataInizio').val();
    const giorniLav = parseInt($('#nuovoGiorniLav').val() || '0', 10);
    
    if (!dataInizio || !giorniLav) {
        $('#nuovoDataFine').val('');
        return;
    }
    
    try {
        const res = await fetch('/api/calcola-data-fine', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data_inizio: dataInizio, giorni_lavorativi: giorniLav })
        });
        if (res.ok) {
            const data = await res.json();
            $('#nuovoDataFine').val(data.data_fine);
        }
    } catch (e) {
        console.error('Errore calcolo data fine:', e);
    }
}

async function salvaNuovoImpegno() {
    const istruttoreId = $('#nuovoIstruttoreId').val();
    const attivitaId = $('#nuovoAttivitaId').val();
    const dataInizio = $('#nuovoDataInizio').val();
    const giorniLav = $('#nuovoGiorniLav').val();
    const note = $('#nuovoNote').val();
    
    if (!istruttoreId || !attivitaId || !dataInizio || !giorniLav) {
        alert('Compila tutti i campi obbligatori');
        return;
    }
    
    const body = {
        istruttore_id: Number(istruttoreId),
        attivita_id: Number(attivitaId),
        data_inizio: dataInizio,
        giorni_lavorativi: Number(giorniLav),
        id_corso: {{ id_corso }},
        note: note || ''
    };
    
    try {
        const res = await fetch('/api/impegni', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        
        if (res.status === 409) {
            // Sovrapposizione
            const err = await res.json();
            let msg = err.messaggio || 'Rilevata sovrapposizione.';
            if (err.conflitti && err.conflitti.length > 0) {
                msg += '\n\nConflitti rilevati:\n';
                err.conflitti.forEach(c => {
                    msg += `- ${c.istruttore} il ${formatData(c.data)}: ${c.attivita} (${formatData(c.data_inizio)} → ${formatData(c.data_fine)})\n`;
                });
            }
            if (confirm(msg + '\n\nVuoi procedere comunque?')) {
                body.force = true;
                const retryRes = await fetch('/api/impegni', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (retryRes.ok) {
                    new bootstrap.Modal($('#modalNuovoImpegno')).hide();
                    location.reload();
                } else {
                    const retryErr = await retryRes.json().catch(() => ({}));
                    alert(`Errore: ${retryRes.status} ${retryErr.error || ''}`);
                }
            }
            return;
        }
        
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            alert(`Errore: ${res.status} ${err.error || ''}`);
            return;
        }
        
        new bootstrap.Modal($('#modalNuovoImpegno')).hide();
        location.reload();
    } catch (e) {
        alert('Errore di rete nel salvataggio impegno');
    }
}
</script>
{% endblock %}
<html xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882"><head>
<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:xd_Signature msdt:dt="string"></mso:xd_Signature>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor msdt:dt="string">Grifasi Angelo Giuseppe</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor>
<mso:Order msdt:dt="string">192500.000000000</mso:Order>
<mso:ComplianceAssetId msdt:dt="string"></mso:ComplianceAssetId>
<mso:TemplateUrl msdt:dt="string"></mso:TemplateUrl>
<mso:xd_ProgID msdt:dt="string"></mso:xd_ProgID>
<mso:_ExtendedDescription msdt:dt="string"></mso:_ExtendedDescription>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author msdt:dt="string">Grifasi Angelo Giuseppe</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author>
<mso:TriggerFlowInfo msdt:dt="string"></mso:TriggerFlowInfo>
<mso:ContentTypeId msdt:dt="string">0x0101002AC836DBC1B2D14B9CF1B153B23CAC72</mso:ContentTypeId>
<mso:_SourceUrl msdt:dt="string"></mso:_SourceUrl>
<mso:_SharedFileIndex msdt:dt="string"></mso:_SharedFileIndex>
<mso:TaxCatchAll msdt:dt="string"></mso:TaxCatchAll>
<mso:MediaServiceImageTags msdt:dt="string"></mso:MediaServiceImageTags>
<mso:lcf76f155ced4ddcb4097134ff3c332f msdt:dt="string"></mso:lcf76f155ced4ddcb4097134ff3c332f>
</mso:CustomDocumentProperties>
</xml><![endif]-->
<title></title></head>