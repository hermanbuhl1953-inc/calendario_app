{% extends "base.html" %}

{% block title %}Calendario {{ anno }} - Calendario Istruttori{% endblock %}

{% block extra_head %}
<style>
.calendario-container {
    overflow-x: auto;
    margin-top: 20px;
}

.calendario-table {
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.7rem;
}

.calendario-table th,
.calendario-table td {
    border: 1px solid #ddd;
    padding: 2px;
    text-align: center;
    min-width: 15px;
    height: 25px;
}

.calendario-table thead th {
    background-color: #34495E;
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
    font-size: 0.65rem;
}

.weekend-header {
    background-color: #95a5a6 !important;
    color: white !important;
}

.cella-weekend {
    background-color: #e8e8e8 !important;
}

.cella-festivo {
    background-color: #d0d0d0 !important;
    opacity: 0.9;
}

.istruttore-hidden {
    display: none !important;
}

.istruttore-nome {
    cursor: pointer;
    transition: background-color 0.2s;
}

.istruttore-nome:hover {
    background-color: #3498db !important;
    color: white !important;
}

.istruttore-selected {
    background-color: #2ecc71 !important;
    color: white !important;
}

.vista-singola .cella-giorno {
    height: 40px !important;
    font-size: 0.8rem !important;
}

/* Scala di blu per i mesi */
.mese-header-1 { background-color: #E8F4F8 !important; }
.mese-header-2 { background-color: #D4E9F7 !important; }
.mese-header-3 { background-color: #C0DEEF !important; }
.mese-header-4 { background-color: #ACD3E7 !important; }
.mese-header-5 { background-color: #98C8DF !important; }
.mese-header-6 { background-color: #84BDD7 !important; }
.mese-header-7 { background-color: #70B2CF !important; }
.mese-header-8 { background-color: #5CA7C7 !important; }
.mese-header-9 { background-color: #489CBF !important; }
.mese-header-10 { background-color: #3491B7 !important; }
.mese-header-11 { background-color: #2086AF !important; }
.mese-header-12 { background-color: #0C7BA7 !important; }

.calendario-table tbody th {
    background-color: #ECF0F1;
    position: sticky;
    left: 0;
    z-index: 5;
    font-weight: bold;
    min-width: 150px;
    text-align: left;
    padding-left: 8px;
}

.mese-header {
    background-color: #2C3E50 !important;
    color: white !important;
    font-weight: bold;
}

.cella-giorno {
    cursor: pointer;
    transition: opacity 0.2s;
    color: white;
    font-weight: bold;
    font-size: 0.6rem;
}

.cella-giorno:hover {
    opacity: 0.8;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
}

.cella-vuota {
    background-color: white;
}

.cella-conflitto {
    background-color: #dc3545 !important;
    color: #fff !important;
    font-weight: bold;
}

.anno-selector {
    margin-bottom: 20px;
}

.colonna-evidenziata {
    outline: 2px solid #f39c12;
    box-shadow: inset 0 0 0 2px #f39c12;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-calendar"></i> Calendario {{ anno }}</h2>
        <hr>
    </div>
</div>

<div class="row anno-selector">
    <div class="col-md-6">
        <div class="btn-group" role="group">
            {% for y in [2025, 2026, 2027, 2028, 2029, 2030] %}
            <a href="/calendario/{{ y }}" class="btn btn-{% if y == anno %}primary{% else %}outline-primary{% endif %}">
                {{ y }}
            </a>
            {% endfor %}
        </div>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-warning" id="btnMostraTutti" onclick="mostraTuttiIstruttori()" style="display: none;">
            <i class="fas fa-users"></i> Mostra Tutti
        </button>
        <button class="btn btn-info" onclick="mostraLegenda()">
            <i class="fas fa-info-circle"></i> Legenda Colori
        </button>
        <a href="/export/excel" class="btn btn-success">
            <i class="fas fa-download"></i> Export Excel
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Suggerimento:</strong> Scorri orizzontalmente per vedere tutti i giorni dell'anno. 
            Click su una cella colorata per vedere i dettagli dell'impegno.
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="calendario-container">
            <table class="calendario-table table table-bordered">
                <thead>
                    <!-- Riga mesi -->
                    <tr>
                        <th rowspan="2">ISTRUTTORE</th>
                        {% for mese in mesi %}
                        <th colspan="{{ mese.giorni }}" class="mese-header mese-header-{{ mese.numero }}">{{ mese.nome|upper }}</th>
                        {% endfor %}
                    </tr>
                    <!-- Riga giorni -->
                    <tr>
                        {% set day_index = 1 %}
                        {% for mese in mesi %}
                            {% for giorno_mese in range(1, mese.giorni + 1) %}
                            <th class="day-header" data-giorno="{{ day_index }}" data-weekday="{{ giorno_info[day_index-1].weekday }}">{{ giorno_mese }}</th>
                            {% set day_index = day_index + 1 %}
                            {% endfor %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for istruttore in istruttori %}
                    <tr class="istruttore-row" data-istruttore-id="{{ istruttore.id }}">
                        <th class="istruttore-nome" onclick="filtraIstruttore({{ istruttore.id }}, '{{ istruttore.nome }}')">
                            {{ istruttore.nome }}
                        </th>
                        {% for giorno in range(1, num_giorni + 1) %}
                        <td class="cella-giorno cella-vuota" 
                            data-istruttore="{{ istruttore.nome }}"
                            data-giorno="{{ giorno }}"
                            id="cella-{{ istruttore.id }}-{{ giorno }}">
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Dettaglio Impegno -->
<div class="modal fade" id="modalDettaglio" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Dettaglio Impegno</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDettaglioBody">
                <!-- Contenuto dinamico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                <button type="button" class="btn btn-primary" id="btnVaiCorso" style="display: none;">
                    Vai al Corso
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Legenda -->
<div class="modal fade" id="modalLegenda" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Legenda Colori</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Corsi</h6>
                        <p><span class="badge" style="background-color: #52BE80;">CORSO PDT-CT</span></p>
                        <p><span class="badge" style="background-color: #5DADE2;">CORSO ADT</span></p>
                        <p><span class="badge" style="background-color: #BB8FCE;">CORSO AMC</span></p>
                        <p><span class="badge" style="background-color: #F39C12;">CORSO COMM.LE</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Esami</h6>
                        <p><span class="badge" style="background-color: #3498DB;">ESAME PDT-CT</span></p>
                        <p><span class="badge" style="background-color: #2874A6;">ESAME ADT</span></p>
                        <p><span class="badge" style="background-color: #5499C7;">ESAME AMC</span></p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Assenze</h6>
                        <p><span class="badge" style="background-color: #F1C40F; color: #000;">FERIE</span></p>
                        <p><span class="badge" style="background-color: #E74C3C;">MALATTIA</span></p>
                        <p><span class="badge" style="background-color: #F4D03F; color: #000;">PERMESSO</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Altro</h6>
                        <p><span class="badge" style="background-color: #229954;">ADDESTRAMENTO</span></p>
                        <p><span class="badge" style="background-color: #BB8FCE;">TIROCINIO</span></p>
                        <p><span class="badge" style="background-color: #7F8C8D;">RIUNIONE</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const anno = {{ anno }};
const impegni = {{ impegni|tojson }};
const sostituzioni = {{ sostituzioni|tojson }};
const festivi = {{ festivi|tojson }};
const numGiorni = {{ num_giorni }};
let istruttoreFiltrato = null;

$(document).ready(function() {
    coloraWeekend();
    popolaCalendario();
    scrollToGiornoFromQuery();
});

function filtraIstruttore(istruttoreId, nomeIstruttore) {
    if (istruttoreFiltrato === istruttoreId) {
        // Se è già filtrato, deseleziona
        mostraTuttiIstruttori();
        return;
    }
    
    istruttoreFiltrato = istruttoreId;
    
    // Nascondi tutte le righe tranne quella selezionata
    $('.istruttore-row').each(function() {
        const id = parseInt($(this).data('istruttore-id'));
        if (id === istruttoreId) {
            $(this).show();
            $(this).find('.istruttore-nome').addClass('istruttore-selected');
        } else {
            $(this).addClass('istruttore-hidden');
            $(this).find('.istruttore-nome').removeClass('istruttore-selected');
        }
    });
    
    // Ingrandisci visualizzazione
    $('.calendario-table').addClass('vista-singola');
    
    // Mostra bottone "Mostra Tutti"
    $('#btnMostraTutti').show();
    
    // Update alert
    $('.alert-info').html(`
        <i class="fas fa-user"></i>
        <strong>Visualizzazione Singola:</strong> Stai visualizzando solo <strong>${nomeIstruttore}</strong>. 
        Click su "Mostra Tutti" o sul nome per tornare alla vista completa.
    `);
}

function mostraTuttiIstruttori() {
    istruttoreFiltrato = null;
    
    // Mostra tutte le righe
    $('.istruttore-row').removeClass('istruttore-hidden').show();
    $('.istruttore-nome').removeClass('istruttore-selected');
    
    // Ripristina dimensioni normali
    $('.calendario-table').removeClass('vista-singola');
    
    // Nascondi bottone "Mostra Tutti"
    $('#btnMostraTutti').hide();
    
    // Ripristina alert
    $('.alert-info').html(`
        <i class="fas fa-info-circle"></i>
        <strong>Suggerimento:</strong> Scorri orizzontalmente per vedere tutti i giorni dell'anno. 
        Click su una cella colorata per vedere i dettagli dell'impegno.
        <strong>Click sul nome di un istruttore per vedere solo la sua riga.</strong>
    `);
}

function coloraWeekend() {
    // Colora gli header dei giorni (numeri nel calendario)
    $('.day-header').each(function() {
        const weekday = parseInt($(this).data('weekday'));
        
        if (weekday === 6) {
            // SABATO = GIALLO
            $(this).css('background-color', '#FFD700');
            $(this).css('color', '#000');
            $(this).css('font-weight', 'bold');
        } else if (weekday === 0) {
            // DOMENICA = ROSSO
            $(this).css('background-color', '#FF6B6B');
            $(this).css('color', '#fff');
            $(this).css('font-weight', 'bold');
        }
    });
    
    // Colora le celle del corpo tabella
    for (let g = 1; g <= {{ num_giorni }}; g++) {
        const info = {{ giorno_info|tojson }}.find(x => x.giorno === g);
        if (!info) continue;
        
        const weekday = info.weekday;
        const dataStr = info.data;
        
        const isWeekend = weekday === 0 || weekday === 6;
        const isFestivo = festivi.includes(dataStr);
        
        // Colora tutte le celle di questo giorno
        $(`.cella-giorno[id$="-${g}"]`).each(function() {
            if (isFestivo) {
                $(this).addClass('cella-festivo');
            } else if (isWeekend) {
                $(this).addClass('cella-weekend');
            }
        });
    }
}

function popolaCalendario() {
    // Per ogni impegno, colora le celle corrispondenti
    const inizioAnno = new Date(anno, 0, 1);
    const occupazioni = {};

    impegni.forEach(impegno => {
        const dataInizio = new Date(impegno.data_inizio);
        const dataFine = new Date(impegno.data_fine);
        
        // Calcola giorno inizio e fine nell'anno
        const giornoInizio = Math.floor((dataInizio - inizioAnno) / (1000 * 60 * 60 * 24)) + 1;
        const giornoFine = Math.floor((dataFine - inizioAnno) / (1000 * 60 * 60 * 24)) + 1;
        
        // Crea set dei giorni extra per questo impegno
        const giorniExtra = new Set();
        if (impegno.giorno_extra_1) giorniExtra.add(impegno.giorno_extra_1);
        if (impegno.giorno_extra_2) giorniExtra.add(impegno.giorno_extra_2);
        if (impegno.giorno_extra_3) giorniExtra.add(impegno.giorno_extra_3);
        
        // Registra occupazioni per giorni lavorativi (Lun-Ven) + giorni extra
        for (let g = Math.max(1, giornoInizio); g <= Math.min(giornoFine, {{ num_giorni }}); g++) {
            const dataGiorno = new Date(inizioAnno.getTime() + (g - 1) * 24 * 60 * 60 * 1000);
            const dataGiornoStr = dataGiorno.toISOString().split('T')[0];
            const weekday = dataGiorno.getDay();
            
            const isLunVen = weekday >= 1 && weekday <= 5;
            const isGiornoExtra = giorniExtra.has(dataGiornoStr);
            
            if (isLunVen || isGiornoExtra) {
                const key = `${impegno.istruttore_id}-${g}`;
                if (!occupazioni[key]) occupazioni[key] = [];
                occupazioni[key].push(impegno);
            }
        }
    });

    // Applica sostituzioni PRIMA di renderizzare
    sostituzioni.forEach(sost => {
        const dataSost = new Date(sost.data_sostituzione);
        const giornoSost = Math.floor((dataSost - inizioAnno) / (1000 * 60 * 60 * 24)) + 1;
        
        if (giornoSost >= 1 && giornoSost <= {{ num_giorni }}) {
            // Rimuovi dall'istruttore ORIGINALE
            const keyOrig = `${sost.istruttore_originale_id}-${giornoSost}`;
            if (occupazioni[keyOrig]) {
                occupazioni[keyOrig] = occupazioni[keyOrig].filter(imp => imp.id !== sost.impegno_id);
                if (occupazioni[keyOrig].length === 0) {
                    delete occupazioni[keyOrig];
                }
            }
            
            // Aggiungi all'istruttore SOSTITUTO
            const keySost = `${sost.istruttore_sostituto_id}-${giornoSost}`;
            const impegnoOriginale = impegni.find(i => i.id === sost.impegno_id);
            if (impegnoOriginale) {
                const impegnoSost = {...impegnoOriginale, _sostituzione: sost};
                if (!occupazioni[keySost]) occupazioni[keySost] = [];
                occupazioni[keySost].push(impegnoSost);
            }
        }
    });

    // Renderizza celle in base alle occupazioni
    Object.entries(occupazioni).forEach(([key, items]) => {
        const [istrId, g] = key.split('-');
        const cella = $(`#cella-${istrId}-${g}`);
        if (!cella.length) return;

        cella.removeClass('cella-vuota');

        if (items.length === 1) {
            const impegno = items[0];
            cella.css('background-color', `#${impegno.colore}`);
            cella.text(impegno.attivita_nome.substring(0, 3));
            cella.attr('data-impegno-id', impegno.id);
            cella.attr('data-id-corso', impegno.id_corso || '');
            cella.removeClass('cella-conflitto');
            
            cella.off('click').on('click', function() {
                if (impegno._sostituzione) {
                    mostraDettaglioSostituzione(impegno, impegno._sostituzione);
                } else {
                    mostraDettaglioImpegno(impegno);
                }
            });
        } else {
            cella.addClass('cella-conflitto');
            cella.text(`${items.length}×`);
            cella.off('click').on('click', function() {
                mostraConflittoCalendario(items, parseInt(g, 10));
            });
        }
    });
    
    // Applica sostituzioni
    sostituzioni.forEach(sost => {
        const dataSost = new Date(sost.data_sostituzione);
        const inizioAnno = new Date(anno, 0, 1);
        const giornoSost = Math.floor((dataSost - inizioAnno) / (1000 * 60 * 60 * 24)) + 1;
        
        // Trova l'impegno originale per ottenere il colore
        const impegnoOriginale = impegni.find(i => i.id === sost.impegno_id);
        
        if (impegnoOriginale && giornoSost >= 1 && giornoSost <= {{ num_giorni }}) {
            // Rimuovi colore dalla cella dell'istruttore ORIGINALE
            const cellaOriginale = $(`#cella-${sost.istruttore_originale_id}-${giornoSost}`);
            if (cellaOriginale.length) {
                cellaOriginale.addClass('cella-vuota');
                cellaOriginale.css('background-color', 'white');
                cellaOriginale.text('');
                cellaOriginale.off('click');
            }
            
            // Colora la cella dell'istruttore SOSTITUTO
            const cellaSostituto = $(`#cella-${sost.istruttore_sostituto_id}-${giornoSost}`);
            if (cellaSostituto.length) {
                cellaSostituto.removeClass('cella-vuota');
                cellaSostituto.css('background-color', `#${sost.colore}`);
                cellaSostituto.text(impegnoOriginale.attivita_nome.substring(0, 3));
                cellaSostituto.attr('data-sostituzione-id', sost.id);
                cellaSostituto.attr('data-impegno-id', impegnoOriginale.id);
                
                // Click handler con info sostituzione
                cellaSostituto.off('click').on('click', function() {
                    mostraDettaglioSostituzione(impegnoOriginale, sost);
                });
            }
        }
    });
}

function mostraDettaglioSostituzione(impegno, sost) {
    const html = `
        <div class="alert alert-info">
            <i class="fas fa-exchange-alt"></i> <strong>SOSTITUZIONE</strong>
        </div>
        <p><strong>Data:</strong> ${formatData(sost.data_sostituzione)}</p>
        <p><strong>Istruttore Originale:</strong> ${sost.istruttore_originale}</p>
        <p><strong>Istruttore Sostituto:</strong> ${sost.istruttore_sostituto}</p>
        <p><strong>Attività:</strong> 
            <span class="badge" style="background-color: #${impegno.colore};">
                ${impegno.attivita_nome}
            </span>
        </p>
        ${impegno.id_corso ? `<p><strong>ID Corso:</strong> ${impegno.id_corso}</p>` : ''}
        ${sost.note ? `<p><strong>Motivo:</strong> ${sost.note}</p>` : ''}
    `;
    
    $('#modalDettaglioBody').html(html);
    
    if (impegno.id_corso) {
        $('#btnVaiCorso').show().off('click').on('click', function() {
            window.location.href = `/corso/${encodeURIComponent(impegno.id_corso)}`;
        });
    } else {
        $('#btnVaiCorso').hide();
    }
    
    new bootstrap.Modal($('#modalDettaglio')).show();
}

function mostraConflittoCalendario(items, giornoIndice) {
    const dataGiorno = new Date(anno, 0, giornoIndice);
    const dataStr = dataGiorno.toISOString().split('T')[0];
    const elenco = items.map(imp => `
        <div class="border rounded p-2 mb-2">
            <div><strong>${imp.istruttore_nome}</strong></div>
            <div>${imp.attivita_nome} (${formatData(imp.data_inizio)} → ${formatData(imp.data_fine)})</div>
        </div>
    `).join('');

    const html = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            Conflitto rilevato il ${formatData(dataStr)}
        </div>
        ${elenco}
    `;
    $('#modalDettaglioBody').html(html);
    $('#btnVaiCorso').hide();
    new bootstrap.Modal($('#modalDettaglio')).show();
}

function scrollToGiornoFromQuery() {
    const params = new URLSearchParams(window.location.search);
    const dayParam = params.get('day');
    if (!dayParam) return;
    const targetDate = new Date(dayParam);
    if (Number.isNaN(targetDate.getTime())) return;
    if (targetDate.getFullYear() !== anno) return;
    const giornoAnno = Math.floor((targetDate - new Date(anno, 0, 1)) / (1000 * 60 * 60 * 24)) + 1;
    if (giornoAnno < 1 || giornoAnno > numGiorni) return;
    evidenziaColonna(giornoAnno);
    const headerCell = $('.calendario-table thead tr:eq(1) th').eq(giornoAnno - 1);
    if (!headerCell.length) return;
    const container = $('.calendario-container');
    const scrollLeft = headerCell.position().left + container.scrollLeft() - 60;
    container.animate({ scrollLeft: scrollLeft }, 400);
}

function evidenziaColonna(giorno) {
    const celle = $(`.cella-giorno[id$="-${giorno}"]`);
    const headerCell = $('.calendario-table thead tr:eq(1) th').eq(giorno - 1);
    headerCell.addClass('colonna-evidenziata');
    celle.addClass('colonna-evidenziata');
    setTimeout(() => {
        headerCell.removeClass('colonna-evidenziata');
        celle.removeClass('colonna-evidenziata');
    }, 2500);
}

function mostraDettaglioImpegno(impegno) {
    const html = `
        <p><strong>Istruttore:</strong> ${impegno.istruttore_nome}</p>
        <p><strong>Attività:</strong> 
            <span class="badge" style="background-color: #${impegno.colore};">
                ${impegno.attivita_nome}
            </span>
        </p>
        ${impegno.luogo ? `<p><strong>Luogo:</strong> ${impegno.luogo}</p>` : ''}
        ${impegno.aula ? `<p><strong>Aula:</strong> ${impegno.aula}</p>` : ''}
        ${impegno.posti ? `<p><strong>Posti:</strong> ${impegno.posti}</p>` : ''}
        ${impegno.id_corso ? `<p><strong>ID Corso:</strong> ${impegno.id_corso}</p>` : ''}
        <p><strong>Data Inizio:</strong> ${formatData(impegno.data_inizio)}</p>
        <p><strong>Data Fine:</strong> ${formatData(impegno.data_fine)}</p>
        <p><strong>Giorni Lavorativi:</strong> ${impegno.giorni_lavorativi}</p>
        ${impegno.note ? `<p><strong>Note:</strong> ${impegno.note}</p>` : ''}
    `;
    
    $('#modalDettaglioBody').html(html);
    
    if (impegno.id_corso) {
        $('#btnVaiCorso').show().off('click').on('click', function() {
            window.location.href = `/corso/${encodeURIComponent(impegno.id_corso)}`;
        });
    } else {
        $('#btnVaiCorso').hide();
    }
    
    new bootstrap.Modal($('#modalDettaglio')).show();
}

function mostraDettaglioSostituzione(impegno, sost) {
    const html = `
        <div class="alert alert-info">
            <i class="fas fa-exchange-alt"></i> <strong>SOSTITUZIONE</strong>
        </div>
        <p><strong>Istruttore Originale:</strong> ${sost.istruttore_originale}</p>
        <p><strong>Istruttore Sostituto:</strong> ${sost.istruttore_sostituto}</p>
        <p><strong>Data Sostituzione:</strong> ${formatData(sost.data_sostituzione)}</p>
        <p><strong>Attività:</strong> 
            <span class="badge" style="background-color: #${sost.colore};">
                ${impegno.attivita_nome}
            </span>
        </p>
        ${impegno.id_corso ? `<p><strong>ID Corso:</strong> ${impegno.id_corso}</p>` : ''}
        ${sost.note ? `<p><strong>Motivo:</strong> ${sost.note}</p>` : ''}
    `;
    
    $('#modalDettaglioBody').html(html);
    
    if (impegno.id_corso) {
        $('#btnVaiCorso').show().off('click').on('click', function() {
            window.location.href = `/corso/${encodeURIComponent(impegno.id_corso)}`;
        });
    } else {
        $('#btnVaiCorso').hide();
    }
    
    new bootstrap.Modal($('#modalDettaglio')).show();
}

function formatData(dataStr) {
    if (!dataStr) return '';
    const iso = String(dataStr).split('T')[0];
    const parts = iso.split('-');
    if (parts.length === 3) {
        const [yyyy, mm, dd] = parts;
        return `${dd.padStart(2,'0')}/${mm.padStart(2,'0')}/${yyyy}`;
    }
    const d = new Date(dataStr);
    const day = String(d.getDate()).padStart(2,'0');
    const mon = String(d.getMonth()+1).padStart(2,'0');
    const yr = String(d.getFullYear());
    return `${day}/${mon}/${yr}`;
}

function mostraLegenda() {
    new bootstrap.Modal($('#modalLegenda')).show();
}
</script>
{% endblock %}
<html xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882"><head>
<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:xd_Signature msdt:dt="string"></mso:xd_Signature>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor msdt:dt="string">Grifasi Angelo Giuseppe</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor>
<mso:Order msdt:dt="string">192400.000000000</mso:Order>
<mso:ComplianceAssetId msdt:dt="string"></mso:ComplianceAssetId>
<mso:TemplateUrl msdt:dt="string"></mso:TemplateUrl>
<mso:xd_ProgID msdt:dt="string"></mso:xd_ProgID>
<mso:_ExtendedDescription msdt:dt="string"></mso:_ExtendedDescription>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author msdt:dt="string">Grifasi Angelo Giuseppe</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author>
<mso:TriggerFlowInfo msdt:dt="string"></mso:TriggerFlowInfo>
<mso:ContentTypeId msdt:dt="string">0x0101002AC836DBC1B2D14B9CF1B153B23CAC72</mso:ContentTypeId>
<mso:_SourceUrl msdt:dt="string"></mso:_SourceUrl>
<mso:_SharedFileIndex msdt:dt="string"></mso:_SharedFileIndex>
<mso:TaxCatchAll msdt:dt="string"></mso:TaxCatchAll>
<mso:MediaServiceImageTags msdt:dt="string"></mso:MediaServiceImageTags>
<mso:lcf76f155ced4ddcb4097134ff3c332f msdt:dt="string"></mso:lcf76f155ced4ddcb4097134ff3c332f>
</mso:CustomDocumentProperties>
</xml><![endif]-->
<title></title></head>

