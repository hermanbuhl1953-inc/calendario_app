{% extends "base.html" %}

{% block title %}Calendario {{ anno }} - Calendario Istruttori{% endblock %}

{% block extra_head %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css' rel='stylesheet' />

<style>
/* Tab Navigation */
.calendario-tabs {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    border-bottom: 2px solid #34495E;
}

.calendario-tabs button {
    padding: 10px 20px;
    border: none;
    background: #ecf0f1;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s;
    border-radius: 5px 5px 0 0;
}

.calendario-tabs button:hover {
    background: #bdc3c7;
}

.calendario-tabs button.active {
    background: #34495E;
    color: white;
}

.vista-container {
    display: none;
    padding: 20px 0;
}

.vista-container.active {
    display: block;
}

/* Filtri */
.filtri-calendario {
    display: flex;
    gap: 15px;
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    flex-wrap: wrap;
}

.filtri-calendario select,
.filtri-calendario input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.filtri-calendario button {
    padding: 8px 20px;
    background: #0d6efd;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
}

.filtri-calendario button:hover {
    background: #0b5ed7;
}

/* FullCalendar customization */
#fullcalendar-view {
    max-width: 1400px;
    margin: 0 auto;
}

/* Vista Lista */
.lista-impegni {
    max-width: 1400px;
    margin: 0 auto;
}

.lista-impegni table {
    width: 100%;
    border-collapse: collapse;
}

.lista-impegni th {
    background: #34495E;
    color: white;
    padding: 12px;
    text-align: left;
    cursor: pointer;
    user-select: none;
}

.lista-impegni th:hover {
    background: #2c3e50;
}

.lista-impegni td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
}

.lista-impegni tr:hover {
    background: #f8f9fa;
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
}

.pagination button {
    padding: 8px 15px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 4px;
}

.pagination button:hover:not(:disabled) {
    background: #0d6efd;
    color: white;
}

.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination .page-info {
    padding: 8px 15px;
    display: flex;
    align-items: center;
}

/* Dashboard */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.dashboard-widget {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.dashboard-widget h3 {
    margin: 0 0 15px 0;
    color: #34495E;
    font-size: 16px;
    font-weight: 600;
}

.widget-value {
    font-size: 32px;
    font-weight: bold;
    color: #0d6efd;
    margin: 10px 0;
}

.widget-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.widget-list li {
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.widget-list li:last-child {
    border-bottom: none;
}

.badge-area {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.badge-scorta { background: #ffcccc; color: #c0392b; }
.badge-condotta { background: #cce5ff; color: #0056b3; }
.badge-verifica { background: #ccffcc; color: #27ae60; }
.badge-manovra { background: #ffffcc; color: #f39c12; }

<style>
.calendario-container {
    overflow-x: auto;
    margin-top: 20px;
}

.calendario-table {
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.7rem;
}

.calendario-table th,
.calendario-table td {
    border: 1px solid #ddd;
    padding: 2px;
    text-align: center;
    min-width: 15px;
    height: 25px;
}

.calendario-table thead th {
    background-color: #34495E;
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
    font-size: 0.65rem;
}

.weekend-header {
    background-color: #95a5a6 !important;
    color: white !important;
}

.cella-weekend {
    background-color: #e8e8e8 !important;
}

.cella-festivo {
    background-color: #d0d0d0 !important;
    opacity: 0.9;
}

.istruttore-hidden {
    display: none !important;
}

.istruttore-nome {
    cursor: pointer;
    transition: background-color 0.2s;
}

.istruttore-nome:hover {
    background-color: #3498db !important;
    color: white !important;
}

.istruttore-selected {
    background-color: #2ecc71 !important;
    color: white !important;
}

.vista-singola .cella-giorno {
    height: 40px !important;
    font-size: 0.8rem !important;
}

/* Scala di blu per i mesi */
.mese-header-1 { background-color: #E8F4F8 !important; }
.mese-header-2 { background-color: #D4E9F7 !important; }
.mese-header-3 { background-color: #C0DEEF !important; }
.mese-header-4 { background-color: #ACD3E7 !important; }
.mese-header-5 { background-color: #98C8DF !important; }
.mese-header-6 { background-color: #84BDD7 !important; }
.mese-header-7 { background-color: #70B2CF !important; }
.mese-header-8 { background-color: #5CA7C7 !important; }
.mese-header-9 { background-color: #489CBF !important; }
.mese-header-10 { background-color: #3491B7 !important; }
.mese-header-11 { background-color: #2086AF !important; }
.mese-header-12 { background-color: #0C7BA7 !important; }

.calendario-table tbody th {
    background-color: #ECF0F1;
    position: sticky;
    left: 0;
    z-index: 5;
    font-weight: bold;
    min-width: 150px;
    text-align: left;
    padding-left: 8px;
}

.mese-header {
    background-color: #2C3E50 !important;
    color: white !important;
    font-weight: bold;
}

.cella-giorno {
    cursor: pointer;
    transition: opacity 0.2s;
    color: white;
    font-weight: bold;
    font-size: 0.6rem;
}

.cella-giorno:hover {
    opacity: 0.8;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
}

.cella-vuota {
    background-color: white;
}

.cella-sostituita {
    border: 3px solid #ff9800 !important;
    box-shadow: inset 0 0 5px rgba(255, 152, 0, 0.3) !important;
}

.cella-conflitto {
    background-color: #dc3545 !important;
    color: #fff !important;
    font-weight: bold;
}

.anno-selector {
    margin-bottom: 20px;
}

.colonna-evidenziata {
    outline: 2px solid #f39c12;
    box-shadow: inset 0 0 0 2px #f39c12;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-calendar"></i> Calendario {{ anno }}</h2>
        <hr>
    </div>
</div>

<div class="row anno-selector">
    <div class="col-md-6">
        <div class="btn-group" role="group">
            {% for y in [2025, 2026, 2027, 2028, 2029, 2030] %}
            <a href="/calendario/{{ y }}" class="btn btn-{% if y == anno %}primary{% else %}outline-primary{% endif %}">
                {{ y }}
            </a>
            {% endfor %}
        </div>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-info" onclick="mostraLegenda()">
            <i class="fas fa-info-circle"></i> Legenda Colori
        </button>
        <a href="/export/excel" class="btn btn-success">
            <i class="fas fa-download"></i> Export Excel
        </a>
    </div>
</div>

<!-- Tab Navigation -->
<div class="row">
    <div class="col-12">
        <div class="calendario-tabs">
            <button class="tab-btn active" onclick="cambiaVista('fullcalendar')">
                üìÖ Vista Calendario
            </button>
            <button class="tab-btn" onclick="cambiaVista('timeline')">
                üìä Vista Timeline
            </button>
            <button class="tab-btn" onclick="cambiaVista('lista')">
                üìã Vista Lista
            </button>
            <button class="tab-btn" onclick="cambiaVista('dashboard')">
                üìà Dashboard
            </button>
        </div>
    </div>
</div>

<!-- VISTA 1: FullCalendar -->
<div id="vista-fullcalendar" class="vista-container active">
    <div class="row">
        <div class="col-12">
            <div id="fullcalendar-view"></div>
        </div>
    </div>
</div>

<!-- VISTA 2: Timeline (calendario originale con filtri) -->
<div id="vista-timeline" class="vista-container">
    <div class="row">
        <div class="col-12">
            <div class="filtri-calendario">
                <select id="filtroArea">
                    <option value="">Tutte le aree</option>
                    <option value="Scorta">Scorta</option>
                    <option value="Condotta">Condotta</option>
                    <option value="Verifica">Verifica</option>
                    <option value="Manovra">Manovra</option>
                </select>
                
                <select id="filtroMese">
                    <option value="">Tutto l'anno</option>
                    <option value="1">Gennaio</option>
                    <option value="2">Febbraio</option>
                    <option value="3">Marzo</option>
                    <option value="4">Aprile</option>
                    <option value="5">Maggio</option>
                    <option value="6">Giugno</option>
                    <option value="7">Luglio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Settembre</option>
                    <option value="10">Ottobre</option>
                    <option value="11">Novembre</option>
                    <option value="12">Dicembre</option>
                </select>
                
                <input type="text" id="filtroCerca" placeholder="Cerca istruttore...">
                
                <select id="filtroTipo">
                    <option value="">Tutti i tipi</option>
                    <option value="CORSO">CORSO</option>
                    <option value="FERIE">FERIE</option>
                    <option value="MALATTIA">MALATTIA</option>
                    <option value="COMMISSIONE">COMMISSIONE</option>
                    <option value="RIUNIONE">RIUNIONE</option>
                </select>
                
                <button onclick="applicaFiltri()">Applica Filtri</button>
                <button onclick="resetFiltri()" style="background: #6c757d;">Reset</button>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Suggerimento:</strong> Usa i filtri sopra per ridurre il numero di righe/colonne visualizzate. 
                Click su una cella colorata per vedere i dettagli.
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="calendario-container">
            <table class="calendario-table table table-bordered">
                <thead>
                    <!-- Riga mesi -->
                    <tr>
                        <th rowspan="2">ISTRUTTORE</th>
                        {% for mese in mesi %}
                        <th colspan="{{ mese.giorni }}" class="mese-header mese-header-{{ mese.numero }}">{{ mese.nome|upper }}</th>
                        {% endfor %}
                    </tr>
                    <!-- Riga giorni -->
                    <tr>
                        {% set day_index = 1 %}
                        {% for mese in mesi %}
                            {% for giorno_mese in range(1, mese.giorni + 1) %}
                            <th class="day-header" data-giorno="{{ day_index }}" data-weekday="{{ giorno_info[day_index-1].weekday }}">{{ giorno_mese }}</th>
                            {% set day_index = day_index + 1 %}
                            {% endfor %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for istruttore in istruttori %}
                    <tr class="istruttore-row" data-istruttore-id="{{ istruttore.id }}">
                        <th class="istruttore-nome" onclick="filtraIstruttore({{ istruttore.id }}, '{{ istruttore.nome }}')">
                            {{ istruttore.nome }}
                        </th>
                        {% for giorno in range(1, num_giorni + 1) %}
                        <td class="cella-giorno cella-vuota" 
                            data-istruttore="{{ istruttore.nome }}"
                            data-giorno="{{ giorno }}"
                            id="cella-{{ istruttore.id }}-{{ giorno }}">
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>

<!-- VISTA 3: Lista -->
<div id="vista-lista" class="vista-container">
    <div class="row">
        <div class="col-12 lista-impegni">
            <table id="tabella-lista">
                <thead>
                    <tr>
                        <th onclick="sortLista('istruttore')">Istruttore ‚Üï</th>
                        <th onclick="sortLista('dataInizio')">Data Inizio ‚Üï</th>
                        <th onclick="sortLista('dataFine')">Data Fine ‚Üï</th>
                        <th onclick="sortLista('tipo')">Tipo ‚Üï</th>
                        <th onclick="sortLista('area')">Area ‚Üï</th>
                        <th onclick="sortLista('giorni')">Giorni ‚Üï</th>
                        <th>Note</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tbody-lista">
                    <!-- Popolato da JavaScript -->
                </tbody>
            </table>
            
            <div class="pagination">
                <button onclick="cambPagLista(-1)" id="btn-prev-lista">‚Üê Precedente</button>
                <span class="page-info">Pagina <span id="pag-corrente-lista">1</span> di <span id="pag-totali-lista">1</span></span>
                <button onclick="cambPagLista(1)" id="btn-next-lista">Successiva ‚Üí</button>
            </div>
        </div>
    </div>
</div>

<!-- VISTA 4: Dashboard -->
<div id="vista-dashboard" class="vista-container">
    <div class="row">
        <div class="col-12">
            <div class="dashboard-grid">
                <!-- Widget 1: Impegni Oggi -->
                <div class="dashboard-widget">
                    <h3>üìÖ Impegni Oggi</h3>
                    <div class="widget-value" id="widget-oggi">0</div>
                    <ul class="widget-list" id="widget-oggi-lista"></ul>
                </div>
                
                <!-- Widget 2: Questa Settimana -->
                <div class="dashboard-widget">
                    <h3>üìÜ Questa Settimana</h3>
                    <div class="widget-value" id="widget-settimana">0</div>
                    <ul class="widget-list" id="widget-settimana-lista"></ul>
                </div>
                
                <!-- Widget 3: Conflitti -->
                <div class="dashboard-widget">
                    <h3>‚ö†Ô∏è Conflitti</h3>
                    <div class="widget-value" id="widget-conflitti" style="color: #e74c3c;">0</div>
                    <ul class="widget-list" id="widget-conflitti-lista"></ul>
                </div>
                
                <!-- Widget 4: Istruttori Disponibili -->
                <div class="dashboard-widget">
                    <h3>‚úÖ Disponibili Oggi</h3>
                    <div class="widget-value" id="widget-disponibili">0</div>
                    <ul class="widget-list" id="widget-disponibili-lista"></ul>
                </div>
                
                <!-- Widget 5: Per Area -->
                <div class="dashboard-widget">
                    <h3>üìä Impegni per Area</h3>
                    <ul class="widget-list">
                        <li><span class="badge-area badge-scorta">Scorta</span>: <strong id="widget-area-scorta">0</strong></li>
                        <li><span class="badge-area badge-condotta">Condotta</span>: <strong id="widget-area-condotta">0</strong></li>
                        <li><span class="badge-area badge-verifica">Verifica</span>: <strong id="widget-area-verifica">0</strong></li>
                        <li><span class="badge-area badge-manovra">Manovra</span>: <strong id="widget-area-manovra">0</strong></li>
                    </ul>
                </div>
                
                <!-- Widget 6: Per Tipo -->
                <div class="dashboard-widget">
                    <h3>üìã Impegni per Tipo</h3>
                    <ul class="widget-list">
                        <li>CORSO: <strong id="widget-tipo-corso">0</strong></li>
                        <li>FERIE: <strong id="widget-tipo-ferie">0</strong></li>
                        <li>MALATTIA: <strong id="widget-tipo-malattia">0</strong></li>
                        <li>COMMISSIONE: <strong id="widget-tipo-commissione">0</strong></li>
                        <li>RIUNIONE: <strong id="widget-tipo-riunione">0</strong></li>
                    </ul>
                </div>
            </div>
            
            <!-- Mini calendario mensile sotto dashboard -->
            <div class="row mt-4">
                <div class="col-12">
                    <h4>Calendario Mese Corrente</h4>
                    <div id="dashboard-mini-calendar"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Dettaglio Impegno -->
<div class="modal fade" id="modalDettaglio" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Dettaglio Impegno</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDettaglioBody">
                <!-- Contenuto dinamico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                <button type="button" class="btn btn-primary" id="btnVaiCorso" style="display: none;">
                    Vai al Corso
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Legenda -->
<div class="modal fade" id="modalLegenda" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Legenda Colori</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Corsi</h6>
                        <p><span class="badge" style="background-color: #52BE80;">CORSO PDT-CT</span></p>
                        <p><span class="badge" style="background-color: #5DADE2;">CORSO ADT</span></p>
                        <p><span class="badge" style="background-color: #BB8FCE;">CORSO AMC</span></p>
                        <p><span class="badge" style="background-color: #F39C12;">CORSO COMM.LE</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Esami</h6>
                        <p><span class="badge" style="background-color: #3498DB;">ESAME PDT-CT</span></p>
                        <p><span class="badge" style="background-color: #2874A6;">ESAME ADT</span></p>
                        <p><span class="badge" style="background-color: #5499C7;">ESAME AMC</span></p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Assenze</h6>
                        <p><span class="badge" style="background-color: #F1C40F; color: #000;">FERIE</span></p>
                        <p><span class="badge" style="background-color: #E74C3C;">MALATTIA</span></p>
                        <p><span class="badge" style="background-color: #F4D03F; color: #000;">PERMESSO</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Altro</h6>
                        <p><span class="badge" style="background-color: #229954;">ADDESTRAMENTO</span></p>
                        <p><span class="badge" style="background-color: #BB8FCE;">TIROCINIO</span></p>
                        <p><span class="badge" style="background-color: #7F8C8D;">RIUNIONE</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const anno = {{ anno }};
const impegni = {{ impegni|tojson }};
const sostituzioni = {{ sostituzioni|tojson }};
const festivi = {{ festivi|tojson }};
const numGiorni = {{ num_giorni }};
let istruttoreFiltrato = null;

$(document).ready(function() {
    coloraWeekend();
    popolaCalendario();
    scrollToGiornoFromQuery();
});

function filtraIstruttore(istruttoreId, nomeIstruttore) {
    if (istruttoreFiltrato === istruttoreId) {
        // Se √® gi√† filtrato, deseleziona
        mostraTuttiIstruttori();
        return;
    }
    
    istruttoreFiltrato = istruttoreId;
    
    // Nascondi tutte le righe tranne quella selezionata
    $('.istruttore-row').each(function() {
        const id = parseInt($(this).data('istruttore-id'));
        if (id === istruttoreId) {
            $(this).show();
            $(this).find('.istruttore-nome').addClass('istruttore-selected');
        } else {
            $(this).addClass('istruttore-hidden');
            $(this).find('.istruttore-nome').removeClass('istruttore-selected');
        }
    });
    
    // Ingrandisci visualizzazione
    $('.calendario-table').addClass('vista-singola');
    
    // Mostra bottone "Mostra Tutti"
    $('#btnMostraTutti').show();
    
    // Update alert
    $('.alert-info').html(`
        <i class="fas fa-user"></i>
        <strong>Visualizzazione Singola:</strong> Stai visualizzando solo <strong>${nomeIstruttore}</strong>. 
        Click su "Mostra Tutti" o sul nome per tornare alla vista completa.
    `);
}

function mostraTuttiIstruttori() {
    istruttoreFiltrato = null;
    
    // Mostra tutte le righe
    $('.istruttore-row').removeClass('istruttore-hidden').show();
    $('.istruttore-nome').removeClass('istruttore-selected');
    
    // Ripristina dimensioni normali
    $('.calendario-table').removeClass('vista-singola');
    
    // Nascondi bottone "Mostra Tutti"
    $('#btnMostraTutti').hide();
    
    // Ripristina alert
    $('.alert-info').html(`
        <i class="fas fa-info-circle"></i>
        <strong>Suggerimento:</strong> Scorri orizzontalmente per vedere tutti i giorni dell'anno. 
        Click su una cella colorata per vedere i dettagli dell'impegno.
        <strong>Click sul nome di un istruttore per vedere solo la sua riga.</strong>
    `);
}

function coloraWeekend() {
    // Colora gli header dei giorni (numeri nel calendario)
    $('.day-header').each(function() {
        const weekday = parseInt($(this).data('weekday'));
        
        if (weekday === 6) {
            // SABATO = GIALLO
            $(this).css('background-color', '#FFD700');
            $(this).css('color', '#000');
            $(this).css('font-weight', 'bold');
        } else if (weekday === 0) {
            // DOMENICA = ROSSO
            $(this).css('background-color', '#FF6B6B');
            $(this).css('color', '#fff');
            $(this).css('font-weight', 'bold');
        }
    });
    
    // Colora le celle del corpo tabella
    for (let g = 1; g <= {{ num_giorni }}; g++) {
        const info = {{ giorno_info|tojson }}.find(x => x.giorno === g);
        if (!info) continue;
        
        const weekday = info.weekday;
        const dataStr = info.data;
        
        const isWeekend = weekday === 0 || weekday === 6;
        const isFestivo = festivi.includes(dataStr);
        
        // Colora tutte le celle di questo giorno
        $(`.cella-giorno[id$="-${g}"]`).each(function() {
            if (isFestivo) {
                $(this).addClass('cella-festivo');
            } else if (isWeekend) {
                $(this).addClass('cella-weekend');
            }
        });
    }
}

function popolaCalendario() {
    // Per ogni impegno, colora le celle corrispondenti
    const inizioAnno = new Date(anno, 0, 1);
    const occupazioni = {};
    const giorniSostituzioniPerImpegno = {}; // { impegno_id: Set<giorno> }

    impegni.forEach(impegno => {
        const dataInizio = new Date(impegno.data_inizio);
        const dataFine = new Date(impegno.data_fine);
        
        // Calcola giorno inizio e fine nell'anno
        const giornoInizio = Math.floor((dataInizio - inizioAnno) / (1000 * 60 * 60 * 24)) + 1;
        const giornoFine = Math.floor((dataFine - inizioAnno) / (1000 * 60 * 60 * 24)) + 1;
        
        // Crea set dei giorni extra per questo impegno
        const giorniExtra = new Set();
        if (impegno.giorno_extra_1) giorniExtra.add(impegno.giorno_extra_1);
        if (impegno.giorno_extra_2) giorniExtra.add(impegno.giorno_extra_2);
        if (impegno.giorno_extra_3) giorniExtra.add(impegno.giorno_extra_3);
        
        // Registra occupazioni per giorni lavorativi (Lun-Ven) + giorni extra
        for (let g = Math.max(1, giornoInizio); g <= Math.min(giornoFine, {{ num_giorni }}); g++) {
            const dataGiorno = new Date(inizioAnno.getTime() + (g - 1) * 24 * 60 * 60 * 1000);
            const dataGiornoStr = dataGiorno.toISOString().split('T')[0];
            const weekday = dataGiorno.getDay();
            
            const isLunVen = weekday >= 1 && weekday <= 5;
            const isGiornoExtra = giorniExtra.has(dataGiornoStr);
            
            if (isLunVen || isGiornoExtra) {
                const key = `${impegno.istruttore_id}-${g}`;
                if (!occupazioni[key]) occupazioni[key] = [];
                occupazioni[key].push(impegno);
            }
        }
    });

    // Traccia quali giorni SPECIFICI di un impegno hanno sostituzioni
    sostituzioni.forEach(sost => {
        const dataSost = new Date(sost.data_sostituzione);
        const giornoSost = Math.floor((dataSost - inizioAnno) / (1000 * 60 * 60 * 24)) + 1;
        
        if (giornoSost >= 1 && giornoSost <= {{ num_giorni }}) {
            // Aggiungi questo giorno ai giorni sostituiti di questo impegno
            if (!giorniSostituzioniPerImpegno[sost.impegno_id]) {
                giorniSostituzioniPerImpegno[sost.impegno_id] = new Set();
            }
            giorniSostituzioniPerImpegno[sost.impegno_id].add(giornoSost);
            
            // Aggiungi il sostituto come impegno nella cella del sostituto
            const keySost = `${sost.istruttore_sostituto_id}-${giornoSost}`;
            const impegnoOriginale = impegni.find(i => i.id === sost.impegno_id);
            if (impegnoOriginale) {
                const impegnoSost = {...impegnoOriginale, _sostituzione: sost};
                if (!occupazioni[keySost]) occupazioni[keySost] = [];
                occupazioni[keySost].push(impegnoSost);
            }
        }
    });

    // Renderizza celle in base alle occupazioni
    Object.entries(occupazioni).forEach(([key, items]) => {
        const [istrId, g] = key.split('-');
        const cella = $(`#cella-${istrId}-${g}`);
        if (!cella.length) return;

        cella.removeClass('cella-vuota');

        if (items.length === 1) {
            const impegno = items[0];
            cella.css('background-color', `#${impegno.colore}`);
            
            // Controlla se QUESTO GIORNO √® sostituito
            const √®_giorno_sostituito = giorniSostituzioniPerImpegno[impegno.id]?.has(parseInt(g));
            
            let testo = impegno.attivita_nome.substring(0, 3);
            if (√®_giorno_sostituito) {
                testo += '*';
                cella.addClass('cella-sostituita');
            } else {
                cella.removeClass('cella-sostituita');
            }
            cella.text(testo);
            
            cella.attr('data-impegno-id', impegno.id);
            cella.attr('data-id-corso', impegno.id_corso || '');
            cella.removeClass('cella-conflitto');
            
            cella.off('click').on('click', function() {
                if (impegno._sostituzione) {
                    // √à un sostituto
                    mostraDettaglioSostituzione(impegno, impegno._sostituzione);
                } else {
                    // √à un impegno originale, mostra dettagli
                    mostraDettaglioImpegno(impegno);
                }
            });
        } else {
            cella.addClass('cella-conflitto');
            cella.text(`${items.length}√ó`);
            cella.off('click').on('click', function() {
                mostraConflittoCalendario(items, parseInt(g, 10));
            });
        }
    });
}


function mostraDettaglioSostituzione(impegno, sost) {
    const html = `
        <div class="alert alert-info">
            <i class="fas fa-exchange-alt"></i> <strong>SOSTITUZIONE</strong>
        </div>
        <p><strong>Data:</strong> ${formatData(sost.data_sostituzione)}</p>
        <p><strong>Istruttore Originale:</strong> ${sost.istruttore_originale}</p>
        <p><strong>Istruttore Sostituto:</strong> ${sost.istruttore_sostituto}</p>
        <p><strong>Attivit√†:</strong> 
            <span class="badge" style="background-color: #${impegno.colore};">
                ${impegno.attivita_nome}
            </span>
        </p>
        ${impegno.id_corso ? `<p><strong>ID Corso:</strong> ${impegno.id_corso}</p>` : ''}
        ${sost.note ? `<p><strong>Motivo:</strong> ${sost.note}</p>` : ''}
    `;
    
    $('#modalDettaglioBody').html(html);
    
    if (impegno.id_corso) {
        $('#btnVaiCorso').show().off('click').on('click', function() {
            window.location.href = `/corso/${encodeURIComponent(impegno.id_corso)}`;
        });
    } else {
        $('#btnVaiCorso').hide();
    }
    
    new bootstrap.Modal($('#modalDettaglio')).show();
}

function mostraConflittoCalendario(items, giornoIndice) {
    const dataGiorno = new Date(anno, 0, giornoIndice);
    const dataStr = dataGiorno.toISOString().split('T')[0];
    const elenco = items.map(imp => `
        <div class="border rounded p-2 mb-2">
            <div><strong>${imp.istruttore_nome}</strong></div>
            <div>${imp.attivita_nome} (${formatData(imp.data_inizio)} ‚Üí ${formatData(imp.data_fine)})</div>
        </div>
    `).join('');

    const html = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            Conflitto rilevato il ${formatData(dataStr)}
        </div>
        ${elenco}
    `;
    $('#modalDettaglioBody').html(html);
    $('#btnVaiCorso').hide();
    new bootstrap.Modal($('#modalDettaglio')).show();
}

function scrollToGiornoFromQuery() {
    const params = new URLSearchParams(window.location.search);
    const dayParam = params.get('day');
    if (!dayParam) return;
    const targetDate = new Date(dayParam);
    if (Number.isNaN(targetDate.getTime())) return;
    if (targetDate.getFullYear() !== anno) return;
    const giornoAnno = Math.floor((targetDate - new Date(anno, 0, 1)) / (1000 * 60 * 60 * 24)) + 1;
    if (giornoAnno < 1 || giornoAnno > numGiorni) return;
    evidenziaColonna(giornoAnno);
    const headerCell = $('.calendario-table thead tr:eq(1) th').eq(giornoAnno - 1);
    if (!headerCell.length) return;
    const container = $('.calendario-container');
    const scrollLeft = headerCell.position().left + container.scrollLeft() - 60;
    container.animate({ scrollLeft: scrollLeft }, 400);
}

function evidenziaColonna(giorno) {
    const celle = $(`.cella-giorno[id$="-${giorno}"]`);
    const headerCell = $('.calendario-table thead tr:eq(1) th').eq(giorno - 1);
    headerCell.addClass('colonna-evidenziata');
    celle.addClass('colonna-evidenziata');
    setTimeout(() => {
        headerCell.removeClass('colonna-evidenziata');
        celle.removeClass('colonna-evidenziata');
    }, 2500);
}

function mostraDettaglioImpegno(impegno) {
    const html = `
        <p><strong>Istruttore:</strong> ${impegno.istruttore_nome}</p>
        <p><strong>Attivit√†:</strong> 
            <span class="badge" style="background-color: #${impegno.colore};">
                ${impegno.attivita_nome}
            </span>
        </p>
        ${impegno.luogo ? `<p><strong>Luogo:</strong> ${impegno.luogo}</p>` : ''}
        ${impegno.aula ? `<p><strong>Aula:</strong> ${impegno.aula}</p>` : ''}
        ${impegno.posti ? `<p><strong>Posti:</strong> ${impegno.posti}</p>` : ''}
        ${impegno.id_corso ? `<p><strong>ID Corso:</strong> ${impegno.id_corso}</p>` : ''}
        <p><strong>Data Inizio:</strong> ${formatData(impegno.data_inizio)}</p>
        <p><strong>Data Fine:</strong> ${formatData(impegno.data_fine)}</p>
        <p><strong>Giorni Lavorativi:</strong> ${impegno.giorni_lavorativi}</p>
        ${impegno.note ? `<p><strong>Note:</strong> ${impegno.note}</p>` : ''}
    `;
    
    $('#modalDettaglioBody').html(html);
    
    if (impegno.id_corso) {
        $('#btnVaiCorso').show().off('click').on('click', function() {
            window.location.href = `/corso/${encodeURIComponent(impegno.id_corso)}`;
        });
    } else {
        $('#btnVaiCorso').hide();
    }
    
    new bootstrap.Modal($('#modalDettaglio')).show();
}

function mostraDettaglioSostituzione(impegno, sost) {
    const html = `
        <div class="alert alert-info">
            <i class="fas fa-exchange-alt"></i> <strong>SOSTITUZIONE</strong>
        </div>
        <p><strong>Istruttore Originale:</strong> ${sost.istruttore_originale}</p>
        <p><strong>Istruttore Sostituto:</strong> ${sost.istruttore_sostituto}</p>
        <p><strong>Data Sostituzione:</strong> ${formatData(sost.data_sostituzione)}</p>
        <p><strong>Attivit√†:</strong> 
            <span class="badge" style="background-color: #${sost.colore};">
                ${impegno.attivita_nome}
            </span>
        </p>
        ${impegno.id_corso ? `<p><strong>ID Corso:</strong> ${impegno.id_corso}</p>` : ''}
        ${sost.note ? `<p><strong>Motivo:</strong> ${sost.note}</p>` : ''}
    `;
    
    $('#modalDettaglioBody').html(html);
    
    if (impegno.id_corso) {
        $('#btnVaiCorso').show().off('click').on('click', function() {
            window.location.href = `/corso/${encodeURIComponent(impegno.id_corso)}`;
        });
    } else {
        $('#btnVaiCorso').hide();
    }
    
    new bootstrap.Modal($('#modalDettaglio')).show();
}

function formatData(dataStr) {
    if (!dataStr) return '';
    const iso = String(dataStr).split('T')[0];
    const parts = iso.split('-');
    if (parts.length === 3) {
        const [yyyy, mm, dd] = parts;
        return `${dd.padStart(2,'0')}/${mm.padStart(2,'0')}/${yyyy}`;
    }
    const d = new Date(dataStr);
    const day = String(d.getDate()).padStart(2,'0');
    const mon = String(d.getMonth()+1).padStart(2,'0');
    const yr = String(d.getFullYear());
    return `${day}/${mon}/${yr}`;
}

function mostraLegenda() {
    new bootstrap.Modal($('#modalLegenda')).show();
}

// ========== NUOVE FUNZIONI PER VISTE MULTIPLE ==========

// Cambio vista
function cambiaVista(vista) {
    // Nascondi tutte le viste
    document.querySelectorAll('.vista-container').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    // Mostra vista selezionata
    document.getElementById(`vista-${vista}`).classList.add('active');
    event.target.classList.add('active');
    
    // Inizializza vista se necessario
    if (vista === 'fullcalendar' && !window.fullcalendarInitialized) {
        inizializzaFullCalendar();
        window.fullcalendarInitialized = true;
    } else if (vista === 'lista' && !window.listaInitialized) {
        inizializzaLista();
        window.listaInitialized = true;
    } else if (vista === 'dashboard' && !window.dashboardInitialized) {
        inizializzaDashboard();
        window.dashboardInitialized = true;
    }
}

// ========== VISTA FULLCALENDAR ==========
let calendar;
function inizializzaFullCalendar() {
    const calendarEl = document.getElementById('fullcalendar-view');
    
    // Converti impegni in eventi FullCalendar
    const events = impegni.map(imp => {
        const istruttore = istruttori.find(i => i.id === imp.istruttore_id);
        return {
            id: imp.id,
            title: `${istruttore?.nome || 'N/A'} - ${imp.attivita_nome}`,
            start: imp.data_inizio,
            end: calcolaDataFinePlus1(imp.data_fine), // FullCalendar exclusive end
            backgroundColor: '#' + (imp.colore || '999999'),
            borderColor: '#' + (imp.colore || '999999'),
            extendedProps: {
                impegno: imp,
                istruttore: istruttore
            }
        };
    });
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        initialDate: '{{ anno }}-01-01',
        locale: 'it',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listMonth'
        },
        buttonText: {
            today: 'Oggi',
            month: 'Mese',
            week: 'Settimana',
            list: 'Lista'
        },
        events: events,
        eventClick: function(info) {
            mostraDettaglioImpegno(info.event.extendedProps.impegno);
        },
        height: 'auto'
    });
    
    calendar.render();
}

function calcolaDataFinePlus1(dataFine) {
    const d = new Date(dataFine);
    d.setDate(d.getDate() + 1);
    return d.toISOString().split('T')[0];
}

// ========== FILTRI TIMELINE ==========
function applicaFiltri() {
    const area = document.getElementById('filtroArea').value;
    const mese = document.getElementById('filtroMese').value;
    const cerca = document.getElementById('filtroCerca').value.toLowerCase();
    const tipo = document.getElementById('filtroTipo').value;
    
    // Filtra righe istruttori
    document.querySelectorAll('.istruttore-row').forEach(row => {
        const istruttoreId = row.dataset.istruttoreId;
        const istruttore = istruttori.find(i => i.id == istruttoreId);
        
        let mostra = true;
        
        // Filtro area
        if (area && istruttore.area !== area) mostra = false;
        
        // Filtro cerca
        if (cerca && !istruttore.nome.toLowerCase().includes(cerca)) mostra = false;
        
        row.style.display = mostra ? '' : 'none';
    });
    
    // Filtra colonne mesi (se mese selezionato)
    if (mese) {
        const meseNum = parseInt(mese);
        document.querySelectorAll('.day-header').forEach((th, index) => {
            const giorno = index + 1;
            const data = new Date({{ anno }}, 0, giorno);
            const meseData = data.getMonth() + 1;
            th.style.display = meseData === meseNum ? '' : 'none';
        });
        
        // Nascondi anche celle corrispondenti
        document.querySelectorAll('.cella-giorno').forEach(td => {
            const giorno = parseInt(td.dataset.giorno);
            const data = new Date({{ anno }}, 0, giorno);
            const meseData = data.getMonth() + 1;
            td.style.display = meseData === meseNum ? '' : 'none';
        });
    } else {
        // Mostra tutte le colonne
        document.querySelectorAll('.day-header').forEach(th => th.style.display = '');
        document.querySelectorAll('.cella-giorno').forEach(td => td.style.display = '');
    }
    
    // Filtra per tipo (modifica colori celle)
    if (tipo) {
        document.querySelectorAll('.cella-giorno').forEach(td => {
            const impegnoId = td.dataset.impegnoId;
            if (impegnoId) {
                const impegno = impegni.find(i => i.id == impegnoId);
                if (impegno && !impegno.attivita_nome.includes(tipo)) {
                    td.style.opacity = '0.2';
                } else {
                    td.style.opacity = '1';
                }
            }
        });
    } else {
        document.querySelectorAll('.cella-giorno').forEach(td => td.style.opacity = '1');
    }
}

function resetFiltri() {
    document.getElementById('filtroArea').value = '';
    document.getElementById('filtroMese').value = '';
    document.getElementById('filtroCerca').value = '';
    document.getElementById('filtroTipo').value = '';
    
    // Mostra tutto
    document.querySelectorAll('.istruttore-row').forEach(row => row.style.display = '');
    document.querySelectorAll('.day-header').forEach(th => th.style.display = '');
    document.querySelectorAll('.cella-giorno').forEach(td => {
        td.style.display = '';
        td.style.opacity = '1';
    });
}

// ========== VISTA LISTA ==========
let currentPageLista = 1;
const itemsPerPage = 20;
let impegniOrdinati = [];
let sortColumnLista = 'dataInizio';
let sortDirectionLista = 'asc';

function inizializzaLista() {
    impegniOrdinati = [...impegni];
    sortLista('dataInizio');
}

function sortLista(column) {
    if (sortColumnLista === column) {
        sortDirectionLista = sortDirectionLista === 'asc' ? 'desc' : 'asc';
    } else {
        sortColumnLista = column;
        sortDirectionLista = 'asc';
    }
    
    impegniOrdinati.sort((a, b) => {
        let valA, valB;
        
        switch(column) {
            case 'istruttore':
                const istrA = istruttori.find(i => i.id === a.istruttore_id);
                const istrB = istruttori.find(i => i.id === b.istruttore_id);
                valA = istrA?.nome || '';
                valB = istrB?.nome || '';
                break;
            case 'dataInizio':
                valA = new Date(a.data_inizio);
                valB = new Date(b.data_inizio);
                break;
            case 'dataFine':
                valA = new Date(a.data_fine);
                valB = new Date(b.data_fine);
                break;
            case 'tipo':
                valA = a.attivita_nome;
                valB = b.attivita_nome;
                break;
            case 'area':
                const areaA = istruttori.find(i => i.id === a.istruttore_id)?.area || '';
                const areaB = istruttori.find(i => i.id === b.istruttore_id)?.area || '';
                valA = areaA;
                valB = areaB;
                break;
            case 'giorni':
                valA = calcolaGiorniLavorativi(a.data_inizio, a.data_fine);
                valB = calcolaGiorniLavorativi(b.data_inizio, b.data_fine);
                break;
            default:
                return 0;
        }
        
        if (valA < valB) return sortDirectionLista === 'asc' ? -1 : 1;
        if (valA > valB) return sortDirectionLista === 'asc' ? 1 : -1;
        return 0;
    });
    
    renderLista();
}

function renderLista() {
    const tbody = document.getElementById('tbody-lista');
    const start = (currentPageLista - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageItems = impegniOrdinati.slice(start, end);
    
    tbody.innerHTML = pageItems.map(imp => {
        const istruttore = istruttori.find(i => i.id === imp.istruttore_id);
        const giorni = calcolaGiorniLavorativi(imp.data_inizio, imp.data_fine);
        const badgeClass = `badge-${(istruttore?.area || '').toLowerCase()}`;
        
        return `
            <tr>
                <td>${istruttore?.nome || 'N/A'}</td>
                <td>${formatData(imp.data_inizio)}</td>
                <td>${formatData(imp.data_fine)}</td>
                <td><span class="badge" style="background-color: #${imp.colore};">${imp.attivita_nome}</span></td>
                <td><span class="badge-area ${badgeClass}">${istruttore?.area || 'N/A'}</span></td>
                <td>${giorni}</td>
                <td>${imp.note || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="mostraDettaglioImpegnoById(${imp.id})">üëÅÔ∏è</button>
                </td>
            </tr>
        `;
    }).join('');
    
    // Aggiorna paginazione
    const totPages = Math.ceil(impegniOrdinati.length / itemsPerPage);
    document.getElementById('pag-corrente-lista').textContent = currentPageLista;
    document.getElementById('pag-totali-lista').textContent = totPages;
    document.getElementById('btn-prev-lista').disabled = currentPageLista === 1;
    document.getElementById('btn-next-lista').disabled = currentPageLista === totPages;
}

function cambPagLista(delta) {
    currentPageLista += delta;
    renderLista();
}

function mostraDettaglioImpegnoById(id) {
    const impegno = impegni.find(i => i.id === id);
    if (impegno) mostraDettaglioImpegno(impegno);
}

function calcolaGiorniLavorativi(dataInizio, dataFine) {
    const start = new Date(dataInizio);
    const end = new Date(dataFine);
    let count = 0;
    
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dow = d.getDay();
        if (dow !== 0 && dow !== 6) count++; // Escludi weekend
    }
    
    return count;
}

// ========== VISTA DASHBOARD ==========
function inizializzaDashboard() {
    const oggi = new Date();
    oggi.setHours(0,0,0,0);
    
    const inizioSettimana = new Date(oggi);
    inizioSettimana.setDate(oggi.getDate() - oggi.getDay() + 1);
    
    const fineSettimana = new Date(inizioSettimana);
    fineSettimana.setDate(inizioSettimana.getDate() + 6);
    
    // Impegni oggi
    const impegniOggi = impegni.filter(imp => {
        const start = new Date(imp.data_inizio);
        const end = new Date(imp.data_fine);
        return start <= oggi && end >= oggi;
    });
    
    document.getElementById('widget-oggi').textContent = impegniOggi.length;
    document.getElementById('widget-oggi-lista').innerHTML = impegniOggi.slice(0,5).map(imp => {
        const istr = istruttori.find(i => i.id === imp.istruttore_id);
        return `<li>${istr?.nome || 'N/A'} - ${imp.attivita_nome}</li>`;
    }).join('');
    
    // Impegni questa settimana
    const impegniSettimana = impegni.filter(imp => {
        const start = new Date(imp.data_inizio);
        return start >= inizioSettimana && start <= fineSettimana;
    });
    
    document.getElementById('widget-settimana').textContent = impegniSettimana.length;
    
    // Raggruppa per giorno
    const perGiorno = {};
    impegniSettimana.forEach(imp => {
        const dow = new Date(imp.data_inizio).getDay();
        const giorni = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
        const giorno = giorni[dow];
        perGiorno[giorno] = (perGiorno[giorno] || 0) + 1;
    });
    
    document.getElementById('widget-settimana-lista').innerHTML = Object.entries(perGiorno).map(([g, count]) => 
        `<li>${g}: ${count} impegni</li>`
    ).join('');
    
    // Conflitti (celle con pi√π impegni stesso giorno)
    const conflitti = [];
    for (let g = 1; g <= 365; g++) {
        impegni.forEach(imp => {
            const inizio = Math.ceil((new Date(imp.data_inizio) - new Date({{ anno }}, 0, 1)) / 86400000) + 1;
            const fine = Math.ceil((new Date(imp.data_fine) - new Date({{ anno }}, 0, 1)) / 86400000) + 1;
            
            if (g >= inizio && g <= fine) {
                const key = `${imp.istruttore_id}-${g}`;
                if (!conflitti[key]) conflitti[key] = [];
                conflitti[key].push(imp);
            }
        });
    }
    
    const conflittiCount = Object.values(conflitti).filter(arr => arr.length > 1).length;
    document.getElementById('widget-conflitti').textContent = conflittiCount;
    document.getElementById('widget-conflitti-lista').innerHTML = conflittiCount > 0 ? 
        `<li>${conflittiCount} sovrapposizioni rilevate</li>` : 
        `<li>Nessuna sovrapposizione ‚úÖ</li>`;
    
    // Istruttori disponibili oggi
    const impegnatiOggi = new Set(impegniOggi.map(i => i.istruttore_id));
    const disponibili = istruttori.filter(i => !impegnatiOggi.has(i.id));
    
    document.getElementById('widget-disponibili').textContent = disponibili.length;
    document.getElementById('widget-disponibili-lista').innerHTML = disponibili.slice(0,10).map(i => 
        `<li>${i.nome} <span class="badge-area badge-${i.area.toLowerCase()}">${i.area}</span></li>`
    ).join('');
    
    // Per area
    const perArea = { Scorta: 0, Condotta: 0, Verifica: 0, Manovra: 0 };
    impegni.forEach(imp => {
        const istr = istruttori.find(i => i.id === imp.istruttore_id);
        if (istr && perArea[istr.area] !== undefined) {
            perArea[istr.area]++;
        }
    });
    
    document.getElementById('widget-area-scorta').textContent = perArea.Scorta;
    document.getElementById('widget-area-condotta').textContent = perArea.Condotta;
    document.getElementById('widget-area-verifica').textContent = perArea.Verifica;
    document.getElementById('widget-area-manovra').textContent = perArea.Manovra;
    
    // Per tipo
    const perTipo = { CORSO: 0, FERIE: 0, MALATTIA: 0, COMMISSIONE: 0, RIUNIONE: 0 };
    impegni.forEach(imp => {
        const nome = imp.attivita_nome.toUpperCase();
        if (nome.includes('CORSO')) perTipo.CORSO++;
        else if (nome.includes('FERIE')) perTipo.FERIE++;
        else if (nome.includes('MALATTIA')) perTipo.MALATTIA++;
        else if (nome.includes('COMMISSIONE')) perTipo.COMMISSIONE++;
        else if (nome.includes('RIUNIONE')) perTipo.RIUNIONE++;
    });
    
    document.getElementById('widget-tipo-corso').textContent = perTipo.CORSO;
    document.getElementById('widget-tipo-ferie').textContent = perTipo.FERIE;
    document.getElementById('widget-tipo-malattia').textContent = perTipo.MALATTIA;
    document.getElementById('widget-tipo-commissione').textContent = perTipo.COMMISSIONE;
    document.getElementById('widget-tipo-riunione').textContent = perTipo.RIUNIONE;
    
    // Mini calendario
    inizializzaMiniCalendar();
}

function inizializzaMiniCalendar() {
    const calendarEl = document.getElementById('dashboard-mini-calendar');
    
    const events = impegni.map(imp => {
        const istruttore = istruttori.find(i => i.id === imp.istruttore_id);
        return {
            title: `${istruttore?.nome || 'N/A'} - ${imp.attivita_nome}`,
            start: imp.data_inizio,
            end: calcolaDataFinePlus1(imp.data_fine),
            backgroundColor: '#' + (imp.colore || '999999')
        };
    });
    
    const miniCal = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        initialDate: new Date(),
        locale: 'it',
        headerToolbar: {
            left: 'prev,next',
            center: 'title',
            right: ''
        },
        events: events,
        height: 400
    });
    
    miniCal.render();
}

</script>

<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

{% endblock %}
<html xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882"><head>
<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:xd_Signature msdt:dt="string"></mso:xd_Signature>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor msdt:dt="string">Grifasi Angelo Giuseppe</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor>
<mso:Order msdt:dt="string">192400.000000000</mso:Order>
<mso:ComplianceAssetId msdt:dt="string"></mso:ComplianceAssetId>
<mso:TemplateUrl msdt:dt="string"></mso:TemplateUrl>
<mso:xd_ProgID msdt:dt="string"></mso:xd_ProgID>
<mso:_ExtendedDescription msdt:dt="string"></mso:_ExtendedDescription>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author msdt:dt="string">Grifasi Angelo Giuseppe</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author>
<mso:TriggerFlowInfo msdt:dt="string"></mso:TriggerFlowInfo>
<mso:ContentTypeId msdt:dt="string">0x0101002AC836DBC1B2D14B9CF1B153B23CAC72</mso:ContentTypeId>
<mso:_SourceUrl msdt:dt="string"></mso:_SourceUrl>
<mso:_SharedFileIndex msdt:dt="string"></mso:_SharedFileIndex>
<mso:TaxCatchAll msdt:dt="string"></mso:TaxCatchAll>
<mso:MediaServiceImageTags msdt:dt="string"></mso:MediaServiceImageTags>
<mso:lcf76f155ced4ddcb4097134ff3c332f msdt:dt="string"></mso:lcf76f155ced4ddcb4097134ff3c332f>
</mso:CustomDocumentProperties>
</xml><![endif]-->
<title></title></head>

