{% extends "base.html" %}

{% block title %}{{ istruttore.nome }} - Calendario Istruttori{% endblock %}

{% block extra_head %}
<style>
.stat-card {
    transition: transform 0.2s;
}
.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.calendario-istruttore {
    overflow-x: auto;
    margin-top: 20px;
}
.calendario-istruttore table {
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.7rem;
}
.calendario-istruttore th,
.calendario-istruttore td {
    border: 1px solid #ddd;
    padding: 2px;
    text-align: center;
    min-width: 15px;
    height: 25px;
}
.calendario-istruttore thead th {
    background-color: #34495E;
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
    font-size: 0.65rem;
}
.mese-header {
    background-color: #2C3E50 !important;
    color: white !important;
    font-weight: bold;
}
.cella-giorno {
    cursor: pointer;
    transition: opacity 0.2s;
    color: white;
    font-weight: bold;
    font-size: 0.6rem;
}
.cella-giorno:hover {
    opacity: 0.8;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
}
.cella-vuota {
    background-color: white;
}
.weekend-header {
    background-color: #95a5a6 !important;
    color: white !important;
}
.cella-weekend {
    background-color: #f8f9fa !important;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <a href="/vista_istruttori" class="btn btn-secondary mb-3">
            <i class="fas fa-arrow-left"></i> Torna a Vista Istruttori
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h3><i class="fas fa-user-tie"></i> {{ istruttore.nome }}</h3>
                <p class="mb-0">Report Completo Anno {{ anno }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Statistiche Principali -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card stat-card border-primary">
            <div class="card-body text-center">
                <h2 class="text-primary">{{ totale_impegni }}</h2>
                <p class="text-muted mb-0">Impegni Totali</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card border-success">
            <div class="card-body text-center">
                <h2 class="text-success">{{ totale_giorni }}</h2>
                <p class="text-muted mb-0">Giorni Lavorativi</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card border-warning">
            <div class="card-body text-center">
                <h2 class="text-warning">{{ sost_out|length }}</h2>
                <p class="text-muted mb-0">Sostituzioni OUT</p>
                <small class="text-muted">(è stato sostituito)</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card border-info">
            <div class="card-body text-center">
                <h2 class="text-info">{{ sost_in|length }}</h2>
                <p class="text-muted mb-0">Sostituzioni IN</p>
                <small class="text-muted">(ha sostituito)</small>
            </div>
        </div>
    </div>
</div>

<!-- Giorni Netti -->
<div class="row mt-3">
    <div class="col-12">
        <div class="alert alert-info">
            <strong><i class="fas fa-calculator"></i> Giorni Lavorativi Netti:</strong>
            {{ totale_giorni }} (totale) - {{ sost_out|length }} (sostituito) + {{ sost_in|length }} (ha sostituito) = 
            <strong>{{ totale_giorni_netti }} giorni</strong>
        </div>
    </div>
</div>

<!-- Statistiche per Categoria -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Suddivisione per Categoria</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for categoria, stats in stats_categoria.items() %}
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6>{{ categoria }}</h6>
                                <p class="mb-1"><strong>Impegni:</strong> {{ stats.count }}</p>
                                <p class="mb-0"><strong>Giorni:</strong> {{ stats.giorni }}</p>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: {{ (stats.giorni / totale_giorni * 100) if totale_giorni > 0 else 0 }}%">
                                        {{ "%.1f"|format((stats.giorni / totale_giorni * 100) if totale_giorni > 0 else 0) }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Grafico Mensile -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Giorni Lavorativi per Mese</h5>
            </div>
            <div class="card-body">
                <canvas id="graficoMensile" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Calendario Annuale -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Calendario Annuale {{ anno }}</h5>
            </div>
            <div class="card-body">
                <div class="calendario-istruttore">
                    <table>
                        <thead>
                            <tr>
                                <th style="min-width: 150px;">Mese</th>
                                {% for g in range(1, 32) %}
                                <th>{{ g }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for mese in mesi %}
                            <tr>
                                <th class="mese-header">{{ mese.nome }}</th>
                                {% for g in range(1, 32) %}
                                    {% if g <= mese.giorni %}
                                    <td id="cella-{{ mese.numero }}-{{ g }}" class="cella-vuota"></td>
                                    {% else %}
                                    <td style="background-color: #f0f0f0;"></td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sostituzioni -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card border-warning">
            <div class="card-header bg-warning">
                <h5 class="mb-0"><i class="fas fa-user-minus"></i> Sostituzioni OUT ({{ sost_out|length }})</h5>
                <small>Quando {{ istruttore.nome }} è stato sostituito</small>
            </div>
            <div class="card-body">
                {% if sost_out %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Sostituto</th>
                                <th>Attività</th>
                                <th>Motivo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in sost_out %}
                            <tr>
                                <td>{{ s.data_sostituzione }}</td>
                                <td>{{ s.sostituto_nome }}</td>
                                <td>
                                    <span class="badge" style="background-color: #{{ s.colore }};">
                                        {{ s.attivita_nome }}
                                    </span>
                                </td>
                                <td>{{ s.note or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">Nessuna sostituzione registrata</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-user-plus"></i> Sostituzioni IN ({{ sost_in|length }})</h5>
                <small>Quando {{ istruttore.nome }} ha sostituito altri</small>
            </div>
            <div class="card-body">
                {% if sost_in %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Originale</th>
                                <th>Attività</th>
                                <th>Motivo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in sost_in %}
                            <tr>
                                <td>{{ s.data_sostituzione }}</td>
                                <td>{{ s.originale_nome }}</td>
                                <td>
                                    <span class="badge" style="background-color: #{{ s.colore }};">
                                        {{ s.attivita_nome }}
                                    </span>
                                </td>
                                <td>{{ s.note or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">Nessuna sostituzione registrata</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Lista Impegni Completa -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-list"></i> Tutti gli Impegni dell'Anno ({{ impegni|length }})</h5>
            </div>
            <div class="card-body">
                {% if impegni %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID Corso</th>
                                <th>Data Inizio</th>
                                <th>Data Fine</th>
                                <th>Attività</th>
                                <th>Giorni Lav.</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for imp in impegni %}
                            <tr>
                                <td>
                                    {% if imp.id_corso %}
                                    <a href="/corso/{{ imp.id_corso }}" class="badge bg-primary">
                                        {{ imp.id_corso }}
                                    </a>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>{{ imp.data_inizio }}</td>
                                <td>{{ imp.data_fine }}</td>
                                <td>
                                    <span class="badge" style="background-color: #{{ imp.colore }};">
                                        {{ imp.attivita_nome }}
                                    </span>
                                </td>
                                <td>{{ imp.giorni_lavorativi }}</td>
                                <td>{{ imp.note or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <td colspan="4"><strong>TOTALE</strong></td>
                                <td><strong>{{ totale_giorni }}</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">Nessun impegno registrato per questo anno</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Selettore Anno -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h6><i class="fas fa-calendar"></i> Cambia Anno</h6>
                <div class="btn-group" role="group">
                    {% for a in [2025, 2026, 2027, 2028, 2029, 2030] %}
                    <a href="/istruttore/{{ istruttore.id }}/{{ a }}" 
                       class="btn btn-{% if a == anno %}primary{% else %}outline-primary{% endif %}">
                        {{ a }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Dettaglio -->
<div class="modal fade" id="modalDettaglio" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dettaglio Attività</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDettaglioBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const impegni = {{ impegni|tojson }};
const statsMensili = {{ stats_mensili|tojson }};
const anno = {{ anno }};

// Grafico Mensile
const ctx = document.getElementById('graficoMensile').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'],
        datasets: [{
            label: 'Giorni Lavorativi',
            data: [
                statsMensili[1], statsMensili[2], statsMensili[3], statsMensili[4],
                statsMensili[5], statsMensili[6], statsMensili[7], statsMensili[8],
                statsMensili[9], statsMensili[10], statsMensili[11], statsMensili[12]
            ],
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 5
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            title: {
                display: true,
                text: 'Distribuzione Giorni Lavorativi per Mese'
            }
        }
    }
});

// Colora intestazioni e celle weekend
for (let mese = 1; mese <= 12; mese++) {
    for (let giorno = 1; giorno <= 31; giorno++) {
        const data = new Date(anno, mese - 1, giorno);
        // Verifica che il giorno esista nel mese
        if (data.getMonth() + 1 === mese) {
            const weekday = data.getDay(); // 0=Dom, 6=Sab
            
            if (weekday === 0 || weekday === 6) {
                // Colora intestazione (prima riga thead, colonna giorno+1 per lo header "Mese")
                const headerCells = $('.calendario-istruttore thead tr th');
                if (headerCells[giorno]) { // +1 perché la prima colonna è "Mese"
                    $(headerCells[giorno]).addClass('weekend-header');
                }
                
                // Colora cella
                const cella = $(`#cella-${mese}-${giorno}`);
                if (cella.length && cella.hasClass('cella-vuota')) {
                    cella.addClass('cella-weekend');
                }
            }
        }
    }
}

// Popola Calendario
impegni.forEach(imp => {
    const dataInizio = new Date(imp.data_inizio);
    const dataFine = new Date(imp.data_fine);
    
    // Crea set dei giorni extra per questo impegno
    const giorniExtra = new Set();
    if (imp.giorno_extra_1) giorniExtra.add(imp.giorno_extra_1);
    if (imp.giorno_extra_2) giorniExtra.add(imp.giorno_extra_2);
    if (imp.giorno_extra_3) giorniExtra.add(imp.giorno_extra_3);
    
    // Per ogni giorno dell'impegno
    let current = new Date(dataInizio);
    while (current <= dataFine) {
        if (current.getFullYear() === anno) {
            const dataGiornoStr = current.toISOString().split('T')[0];
            const mese = current.getMonth() + 1;
            const giorno = current.getDate();
            const weekday = current.getDay(); // 0=Dom, 1=Lun, ..., 6=Sab
            
            // Colora solo se Lun-Ven OPPURE è nei giorni extra
            const isLunVen = weekday >= 1 && weekday <= 5;
            const isGiornoExtra = giorniExtra.has(dataGiornoStr);
            
            if (isLunVen || isGiornoExtra) {
                const cella = $(`#cella-${mese}-${giorno}`);
                if (cella.length) {
                    cella.removeClass('cella-vuota');
                    cella.addClass('cella-giorno');
                    cella.css('background-color', `#${imp.colore}`);
                    cella.text(imp.attivita_nome.substring(0, 3));
                    
                    // Click handler
                    cella.off('click').on('click', function() {
                        mostraDettaglio(imp);
                    });
                }
            }
        }
        current.setDate(current.getDate() + 1);
    }
});

function mostraDettaglio(impegno) {
    const html = `
        <p><strong>Attività:</strong> 
            <span class="badge" style="background-color: #${impegno.colore};">
                ${impegno.attivita_nome}
            </span>
        </p>
        ${impegno.id_corso ? `<p><strong>ID Corso:</strong> ${impegno.id_corso}</p>` : ''}
        <p><strong>Data Inizio:</strong> ${formatData(impegno.data_inizio)}</p>
        <p><strong>Data Fine:</strong> ${formatData(impegno.data_fine)}</p>
        <p><strong>Giorni Lavorativi:</strong> ${impegno.giorni_lavorativi}</p>
        ${impegno.note ? `<p><strong>Note:</strong> ${impegno.note}</p>` : ''}
    `;
    
    $('#modalDettaglioBody').html(html);
    new bootstrap.Modal($('#modalDettaglio')).show();
}

function formatData(dataStr) {
    const data = new Date(dataStr);
    return data.toLocaleDateString('it-IT');
}
</script>
{% endblock %}
<html xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882"><head>
<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:xd_Signature msdt:dt="string"></mso:xd_Signature>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor msdt:dt="string">Grifasi Angelo Giuseppe</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor>
<mso:Order msdt:dt="string">192600.000000000</mso:Order>
<mso:ComplianceAssetId msdt:dt="string"></mso:ComplianceAssetId>
<mso:TemplateUrl msdt:dt="string"></mso:TemplateUrl>
<mso:xd_ProgID msdt:dt="string"></mso:xd_ProgID>
<mso:_ExtendedDescription msdt:dt="string"></mso:_ExtendedDescription>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author msdt:dt="string">Grifasi Angelo Giuseppe</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author>
<mso:TriggerFlowInfo msdt:dt="string"></mso:TriggerFlowInfo>
<mso:ContentTypeId msdt:dt="string">0x0101002AC836DBC1B2D14B9CF1B153B23CAC72</mso:ContentTypeId>
<mso:_SourceUrl msdt:dt="string"></mso:_SourceUrl>
<mso:_SharedFileIndex msdt:dt="string"></mso:_SharedFileIndex>
<mso:TaxCatchAll msdt:dt="string"></mso:TaxCatchAll>
<mso:MediaServiceImageTags msdt:dt="string"></mso:MediaServiceImageTags>
<mso:lcf76f155ced4ddcb4097134ff3c332f msdt:dt="string"></mso:lcf76f155ced4ddcb4097134ff3c332f>
</mso:CustomDocumentProperties>
</xml><![endif]-->
<title></title></head>